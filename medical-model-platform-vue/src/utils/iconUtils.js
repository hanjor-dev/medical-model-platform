/**
 * SVG图标处理工具：处理后端返回的SVG代码
 * 
 * 功能描述：
 * 1. 解析SVG代码并创建Vue组件
 * 2. 处理SVG的尺寸和样式
 * 3. 提供默认图标映射
 * 4. 支持动态图标生成
 * 
 * @author hanjor
 * @version 1.0
 * @date 2025-01-15
 */

/**
 * 创建SVG图标组件
 * @param {string} svgCode - SVG代码字符串
 * @param {Object} options - 配置选项
 * @returns {Object} Vue组件对象
 */
export const createSvgIcon = (svgCode, options = {}) => {
  if (!svgCode || !svgCode.startsWith('<svg')) {
    return null
  }

  const {
    width = 20,
    height = 20,
    className = 'icon',
    fill = 'currentColor'
  } = options

  // 解析SVG代码
  let processedSvg = svgCode
  
  // 替换尺寸
  processedSvg = processedSvg.replace(/width="[^"]*"/, `width="${width}"`)
  processedSvg = processedSvg.replace(/height="[^"]*"/, `height="${height}"`)
  
  // 添加CSS类
  if (!processedSvg.includes('class="')) {
    processedSvg = processedSvg.replace('<svg', `<svg class="${className}"`)
  }
  
  // 替换填充颜色
  if (fill !== 'currentColor') {
    processedSvg = processedSvg.replace(/fill="[^"]*"/g, `fill="${fill}"`)
  }

  return {
    template: processedSvg
  }
}

/**
 * 获取默认图标
 * @param {string} iconName - 图标名称
 * @returns {Object} 默认图标组件
 */
export const getDefaultIcon = (iconName) => {
  const defaultIcons = {
    dashboard: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M810.666667 213.333333l-85.333334-54.186666V42.666667h85.333334zM810.666667 512h85.333333v-53.717333l-384-268.8-384 268.8V512h85.333333v384h128v-61.056a170.666667 170.666667 0 1 1 341.333334 0V896h128v-384z m85.333333 469.333333h-298.666667v-146.389333a85.333333 85.333333 0 1 0-170.666666 0V981.333333H128v-384H42.666667V413.866667L512 85.333333l469.333333 328.533334V597.333333h-85.333333v384z" fill="currentColor"/>
        </svg>
      `
    },
    system: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M796.601376 533.883517c29.17676 9.213714 56.306028 25.081776 79.340312 45.556695-16.891808 45.044822 5.630603 95.208374 50.675425 112.612055 6.142476 2.047492 12.284951 4.094984 18.427427 4.606857 6.142476 29.688633 6.142476 60.912884 0 90.601517-47.604187 6.654349-80.875931 51.187298-73.709709 98.791485 1.023746 6.654349 2.559365 13.308697 5.11873 19.451173-23.034284 20.474919-49.651679 35.831109-79.340312 45.556695-30.200506-37.366727-85.482787-42.99733-122.849515-12.284951-5.11873 4.094984-9.725587 8.701841-13.82057 13.82057-29.17676-9.213714-56.306028-25.081776-79.340312-45.556695 18.427427-44.532949-3.071238-95.208374-47.092314-113.635801-6.654349-2.559365-13.308697-4.606857-19.963046-5.630603-6.142476-29.688633-6.142476-60.912884 0-90.601517 47.604187-7.166222 80.364058-51.699171 72.685963-99.303358-1.023746-6.142476-2.559365-11.773079-4.606857-17.915554 22.522411-20.474919 49.139806-35.831109 78.316566-45.556695 30.200506 37.366727 84.970914 42.99733 122.337642 12.796824 4.606857-4.094984 9.213714-8.189968 12.796824-12.796824M660.443164 460.685681c-7.678095-1.023746-15.356189-1.023746-22.522411 0-38.902346 12.796824-74.733455 33.271744-105.445834 60.912884-23.546157 20.986792-30.712379 54.770409-18.427427 83.435296 3.071238 7.166222-0.511873 15.356189-7.678095 17.915554-1.023746 0.511873-2.047492 0.511873-3.583111 1.023746-30.712379 4.094984-55.794155 27.129268-62.448503 57.841647-8.701841 40.949838-9.213714 82.923423 0 123.873261 6.142476 29.688633 30.200506 52.211044 59.889138 57.329773 7.678095 0.511873 13.82057 6.654349 13.308698 14.332444v1.535618c-10.749333 28.153014-3.071238 60.401011 19.963046 80.364058 30.712379 27.641141 66.543487 48.11606 105.445834 60.912885 28.664887 9.213714 59.889139 0.511873 79.340311-22.522411 4.606857-6.142476 13.308697-7.166222 19.451174-2.559365 1.023746 0.511873 1.535619 1.535619 2.559365 2.559365 19.451173 23.034284 50.675425 32.247998 78.828438 22.522411 38.902346-12.796824 74.733455-33.271744 105.445834-60.912885 22.522411-19.963046 30.712379-52.211044 19.963046-80.364058-3.071238-7.166222 0.511873-15.356189 7.678095-17.915554 1.023746-0.511873 2.047492-0.511873 3.583111-1.023746 30.200506-4.606857 54.258536-27.129268 60.912884-57.329773 8.189968-39.926092 8.189968-80.875931 0-120.802023-6.142476-30.712379-31.736125-54.258536-62.960376-57.841647-7.678095-1.023746-12.796824-8.189968-11.773079-15.868062 0-1.023746 0.511873-2.047492 1.023746-3.583111 10.23746-28.153014 2.559365-59.889139-19.963046-79.852185-30.712379-27.641141-66.543487-48.11606-105.445834-60.912884-28.664887-9.213714-59.889139-0.511873-79.340311 22.522411-4.606857 6.142476-13.308697 7.166222-19.451174 2.559365-1.023746-0.511873-1.535619-1.535619-2.559364-2.559365-13.82057-15.868062-34.29549-25.593649-55.794155-25.593649" fill="currentColor"/>
        </svg>
      `
    },
    user: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M706.816 629.12a383.872 383.872 0 0 0-123.584-75.968 255.68 255.68 0 0 0 81.216-352.832 255.68 255.68 0 0 0-352.832-81.152A255.68 255.68 0 0 0 230.4 471.936c20.416 32.832 48.448 60.8 81.216 81.216A384.32 384.32 0 0 0 64 895.552c-0.384 8.768 6.4 16.384 15.232 16.768h32.768a16.192 16.192 0 0 0 16-15.168 320.128 320.128 0 0 1 534.848-221.632c6.4 5.632 16 5.632 21.952-0.384l22.848-23.168a16 16 0 0 0-0.832-22.848z m-259.2-101.12a192 192 0 1 1 192-192 192.576 192.576 0 0 1-192 192z m496 224h-24v-34.048c0-47.616-38.4-86.016-86.016-86.016h-3.968c-47.616 0-86.016 38.4-86.016 86.016v33.984h-24a16 16 0 0 0-16 16v160c0 8.832 7.232 16 16 16h224a16 16 0 0 0 16-16V768a16 16 0 0 0-16-16z m-152-34.048c0-20.8 17.216-38.016 38.016-38.016h3.968c20.8 0 38.016 17.216 38.016 38.016v33.984h-80v-33.984z m120 177.984h-160v-96h160V896z" fill="currentColor"/>
        </svg>
      `
    },
    permission: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z" fill="currentColor"/>
          <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z" fill="currentColor"/>
        </svg>
      `
    },
    config: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM368 744c0 4.4-3.6 8-8 8h-56c-4.4 0-8-3.6-8-8V280c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v464zm152-240c0 4.4-3.6 8-8 8h-56c-4.4 0-8-3.6-8-8V280c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v224zm152 240c0 4.4-3.6 8-8 8h-56c-4.4 0-8-3.6-8-8V280c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v464z" fill="currentColor"/>
        </svg>
      `
    },
    business: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M512 64C264.6 64 64 264.6 64 512s200.6 448 448 448 448-200.6 448-448S759.4 64 512 64zm0 820c-205.4 0-372-166.6-372-372s166.6-372 372-372 372 166.6 372 372-166.6 372-372 372z" fill="currentColor"/>
          <path d="M686.7 638.6L544.1 535.5V288c0-4.4-3.6-8-8-8H488c-4.4 0-8 3.6-8 8v275.4c0 2.6 1.2 5 3.3 6.5l165.4 120.6c3.6 2.6 8.6 1.8 11.2-1.7l28.6-39c2.6-3.7 1.8-8.7-1.8-11.2z" fill="currentColor"/>
        </svg>
      `
    },
    file: {
      template: `
        <svg class="icon" viewBox="0 0 1024 1024" width="20" height="20">
          <path d="M880 112H144c-17.7 0-32 14.3-32 32v736c0 17.7 14.3 32 32 32h736c17.7 0 32-14.3 32-32V144c0-17.7-14.3-32-32-32zM368 744c0 4.4-3.6 8-8 8h-56c-4.4 0-8-3.6-8-8V280c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v464zm152-240c0 4.4-3.6 8-8 8h-56c-4.4 0-8-3.6-8-8V280c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v224zm152 240c0 4.4-3.6 8-8 8h-56c-4.4 0-8-3.6-8-8V280c0-4.4 3.6-8 8-8h56c4.4 0 8 3.6 8 8v464z" fill="currentColor"/>
        </svg>
      `
    }
  }

  return defaultIcons[iconName] || defaultIcons.dashboard
}

/**
 * 智能获取图标
 * @param {string|Object} icon - 图标内容（SVG代码或图标名称）
 * @param {Object} options - 配置选项
 * @returns {Object} 图标组件
 */
export const getIcon = (icon, options = {}) => {
  if (!icon) {
    return getDefaultIcon('dashboard')
  }

  // 如果是SVG代码
  if (typeof icon === 'string' && icon.startsWith('<svg')) {
    return createSvgIcon(icon, options)
  }

  // 如果是图标名称
  if (typeof icon === 'string') {
    return getDefaultIcon(icon)
  }

  // 如果是组件对象
  if (typeof icon === 'object' && icon.template) {
    return icon
  }

  return getDefaultIcon('dashboard')
}

/**
 * 验证SVG代码是否有效
 * @param {string} svgCode - SVG代码字符串
 * @returns {boolean} 是否有效
 */
export const isValidSvg = (svgCode) => {
  if (typeof svgCode !== 'string') {
    return false
  }
  
  return svgCode.trim().startsWith('<svg') && svgCode.includes('</svg>')
}

/**
 * 提取SVG的viewBox
 * @param {string} svgCode - SVG代码字符串
 * @returns {string|null} viewBox值
 */
export const extractViewBox = (svgCode) => {
  if (!isValidSvg(svgCode)) {
    return null
  }
  
  const match = svgCode.match(/viewBox="([^"]*)"/)
  return match ? match[1] : null
} 