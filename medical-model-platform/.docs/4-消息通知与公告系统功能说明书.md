# 功能说明：消息通知与系统公告（前后端全景）

## 一、整体概述
- 本模块负责“站内消息通知（User Message）”与“系统公告（Announcement）”两类信息的生产、分发、呈现与已读管理。
- 前端通过 WebSocket 实时接收事件并“补拉”数据，同时提供消息铃铛、消息中心、公告弹窗等界面；后端统一以 ApiResult<T> 返回，并通过统一的异常与错误码体系保障一致性。
- 实时链路：后端在相关业务流程中触发 WebSocket 事件（如 NEW_MESSAGE、NEW_ANNOUNCEMENT），前端收到事件仅做无侵入刷新或弹窗提示，再调用 REST 接口拉取详细数据，确保数据一致性与幂等。

## 二、前端实现
### 1. 数据来源与核心模块
- WebSocket 地址与主题：由 `wsConfig` 统一管理，包含四类主题：角色变更、用户变更、用户消息、用户公告。消息连接会携带 userId 实现定向推送，公告为广播主题（可选 userId）。
- 实时客户端：`realtimeWsClient` 提供单主题客户端与聚合客户端。通知专用的 `createNotificationWsClient` 仅管理“用户消息”和“用户公告”两个主题，具备指数退避重连与错误兜底。
- 通知状态管理：`stores/notification` 负责本地状态、接口调用与 WS 事件处理，提供：
  - 消息：获取我的消息列表、标记单条已读、全部已读、计算未读数；
  - 公告：获取未读可见公告、展示公告弹窗、标记已读、关闭弹窗；
  - 连接：初始化/停止 WebSocket、启动引导补拉、重置状态。

### 2. 页面与交互
- 顶部消息铃铛：`NotificationBell` 显示未读数与最近三条消息，支持“一键全部已读”和跳转消息详情；首次打开下拉时拉取最新列表。
- 公告弹窗：`AnnouncementPopup` 基于对话框显示公告标题、时间与内容；支持强制阅读（隐藏关闭按钮）与“立即查看/稍后查看”。确认后跳转详情并标记已读。
- 应用级初始化：`AppLayout` 监听登录状态变化，用户登录后立即初始化 WebSocket 与通知数据；登出时清理连接与状态，避免泄漏。

### 3. 接口调用约定
- 消息（用户端）：分页查询、详情、标记单条已读、全部已读。
- 公告（用户端）：分页获取可见公告、分页获取未读可见公告、详情、标记已读。
- 通知偏好（用户端）：查询与保存渠道偏好、类型偏好。前端通过独立 API 使用，不与 WS 流程直接耦合。

### 4. 前端事件处理策略
- 新消息事件（NEW_MESSAGE）：校验 event 与 userId，匹配当前用户后刷新“我的消息”列表和未读计数；不直接弹窗，避免打扰。
- 新公告事件（NEW_ANNOUNCEMENT）：若事件携带标题/内容，直接弹出公告；否则仅触发补拉未读公告列表。所有公告以弹窗形式提示，并支持强制阅读。
- 启动补拉：登录或刷新后，主动拉取“我的消息（含未读计数）”与“未读可见公告”。若存在未读公告且当前未展示弹窗，会自动弹出第一条。

## 三、后端实现
### 1. WebSocket 主题与处理器
- 主题常量集中：`WebSocketTopics` 定义四个主题路径，前后端严格一致。
- 通用 WS 处理器：`RealtimeWebSocketHandler` 维护“topic -> sessions”与“userId -> sessions”两个映射：
  - 用户消息：要求连接时带 `?userId=xxx`，否则拒绝；推送仅定向，不回退广播。
  - 用户公告：允许广播订阅（不要求 userId），当定向连接缺失时回退为广播，保证公告触达。
  - 统一发送：提供 sendEvent/sendEventToUserOrTopic 及多种便捷方法（角色变更、用户变更、新消息、新公告）。

### 2. 站内消息模块（Message）
- 控制器：
  - 管理端 `AdminMessageController`：创建、取消、分页查询（需 SUPER_ADMIN）。
  - 用户端 `UserMessageController`：我的消息分页、详情、标记已读、全部已读（从登录上下文取用户ID）。
- 服务接口与实现：`MessageService`/`MessageServiceImpl`
  - 创建：入参校验（接收人/内容必填、调度时间不得早于当前），持久化消息记录；若需立即分发则调用“消息分发器”。
  - 取消：仅未完成状态可取消，违规抛出业务异常。
  - 分页：支持按用户/类型/状态过滤，组装 `MessageVO`；并通过 `MessageRead` 关系表合并已读状态；类型标签来自字典（DICT_4.2）。
  - 统计未读：总数-已读数；详情与已读接口均做越权校验。
- 分发器：`DefaultMessageDispatcher`
  - 渠道决策：通过 `NotificationRouter` 结合模板允许渠道（动态取自字典 DICT_4.1）与用户偏好计算最终渠道集合；系统保证站内渠道（inbox）永远开启。
  - 站内信：通过 WS 发送 `NEW_MESSAGE` 事件，前端再拉取列表；邮件/短信按实现发送，任何失败不影响主流程，仅记录日志。

### 3. 系统公告模块（Announcement）
- 控制器：
  - 管理端 `AdminAnnouncementController`：创建/更新（草稿）、发布、下线、分页（需 SUPER_ADMIN）。
  - 用户端 `UserAnnouncementController`：可见公告分页、未读且可见公告分页、详情、标记已读。
- 服务接口与实现：`AnnouncementService`/`AnnouncementServiceImpl`
  - 创建/更新：校验生效时间窗口（from <= to），仅草稿可更新。
  - 发布：仅草稿可发布；若生效时间已到，立即触发领域事件 `AnnouncementPublishedEvent`；否则投递延时消息，待到点推送。
  - 下线：仅已发布可下线。
  - 查询：可见列表按优先级与时间窗过滤；未读可见列表会排除 `AnnouncementRead` 中已读记录。
  - 标记已读：对 `AnnouncementRead` 做幂等插入。
- 事件订阅：`AnnouncementEventSubscriber`
  - 监听 `AnnouncementPublishedEvent` 并通过 WS 推送 `NEW_ANNOUNCEMENT`（对无定向连接回退广播），确保前端能即时收到弹窗或触发补拉。
- 定时/延时：通过 `RabbitAnnouncementConfig` 与消息队列在“未到生效时间”时延迟触发推送逻辑（发布后安排）。

### 4. 通知偏好与字典
- 用户偏好：`UserNotifyPreferenceServiceImpl` 管理“渠道偏好（channel）”与“类型偏好（type）”。默认策略为“全部开启”，但强制：站内渠道与系统类型不可关闭，保证关键消息触达。
- 字典：
  - DICT_4.1：动态渠道集合（如 inbox/email/sms），用于模板允许渠道与实际可用渠道的交集。
  - DICT_4.2：消息类型集合（如 system/task/credit/...），用于渲染标签与类型偏好管理。

## 四、数据流与状态流转
### 1. 站内消息
- 生成：管理端直接创建或由业务事件驱动创建 → 保存消息记录。
- 分发：消息分发器依据用户偏好与渠道字典确定渠道；站内渠道触发 WS 事件 `NEW_MESSAGE`。
- 前端：收到事件后刷新“我的消息”列表与未读计数；用户可在铃铛下拉或消息中心阅读并标记已读（单条/全部）。
- 统计：未读数 = 用户总消息数 - 用户已读数（`MessageRead`）。

### 2. 系统公告
- 生成/发布：管理端创建草稿，发布时校验并按“立即或延时”安排推送；立即发布触发领域事件；延时发布由队列到点触发。
- 推送：事件订阅者通过 WS 发送 `NEW_ANNOUNCEMENT`，若定向连接缺失则广播到主题。
- 前端：收到事件后直接弹窗（若携带标题/内容）或补拉未读列表；用户确认后跳转详情并标记已读，或稍后关闭。
- 可见性：仅在生效时间窗内的“已发布公告”对用户可见；“未读可见”接口用于登录/刷新时的补拉场景。

## 五、权限、安全与健壮性
- 后端接口统一返回 `ApiResult<T>`；业务异常统一抛出 `ServiceException` 并由全局处理器规范化响应。
- 管理端接口均要求 `SUPER_ADMIN`；用户端接口从登录上下文（Sa-Token）解析当前用户。
- 消息与公告的“详情/已读”接口校验越权，确保用户仅能操作自身数据。
- WebSocket：
  - 用户消息主题要求连接时携带 `userId`；否则拒绝连接。
  - 公告主题允许广播订阅，并在定向连接缺失时回退广播，避免漏达。
  - 采用指数退避策略重连，日志埋点完善，避免雪崩与日志噪音。

## 六、用户体验与交互准则
- 非打扰：新消息仅刷新列表与未读数，不强制弹窗。
- 高优先级提示：公告以弹窗提示，支持“强制阅读”以确保关键通知触达。
- 一致性：所有时间显示与标签渲染在前端统一处理，类型中文标签来自字典映射。
- 稳定性：前端以“事件触发 + 补拉数据”的方式保证数据一致与幂等；即使 WS 丢失也能在登录/刷新时通过补拉恢复状态。

## 七、可运维与可观测性
- 日志：
  - 前端：WS 连接、消息接收、补拉与弹窗行为均有 info/debug 级别日志。
  - 后端：控制器入口、服务层核心动作、分发器渠道执行、WS 推送、队列投递与触发均有日志面包屑。
- 降级：
  - WS 异常或断线：前端自动重连并在登录/刷新时补拉；公告具广播回退，消息为定向投递（不回退，以避免隐私泄露）。
  - 渠道失败：单渠道失败不影响整体创建流程，按“尽力而为”策略记录日志并继续。

## 八、边界与约束
- 站内消息严格定向，不做广播回退；若用户不在线，将在其下次在线时通过“拉取列表”获取。
- 公告支持广播，有效时间窗外的公告不会出现在可见列表；强制阅读仅影响前端交互，不影响数据接口。
- 偏好设置强制开启“站内渠道”和“系统类型”，以保证关键系统信息触达。

## 九、扩展与演进建议
- 渠道丰富：完善短信与站内推送模板，支持 Markdown/富文本渲染规范与内容安全检查。
- 可靠送达：为 WS 事件增加轻量 ACK 与重试策略，或引入服务端事件（SSE）作为回退方案。
- 多端一致：移动端/客户端复用相同的 WS 主题与 REST 接口，统一行为与埋点字段。
- 归档与清理：增加消息/公告的归档与自动清理策略，降低存储压力。

---
文档说明：本文为文字性功能说明，聚焦行为与流程描述，不包含任何代码片段，适合长期归档与团队协作参考。
