# 医学影像模型管理平台 - 团队系统功能说明书

**文档版本**: v1.0  
**创建时间**: 2025-10-23  
**最后更新**: 2025-10-23  
**文档状态**: 已实现功能说明

---

## 📋 目录

1. [系统概述](#1-系统概述)
2. [核心特性](#2-核心特性)
3. [角色与权限模型](#3-角色与权限模型)
4. [数据模型](#4-数据模型)
5. [业务流程](#5-业务流程)
6. [系统配置](#6-系统配置)
7. [WebSocket 推送与事件](#7-websocket-推送与事件)
8. [API 接口说明](#8-api-接口说明)
9. [安全、异常与审计](#9-安全异常与审计)
10. [使用指南](#10-使用指南)
11. [技术架构](#11-技术架构)
12. [错误码参考](#12-错误码参考)

---

## 1. 系统概述

### 1.1 功能定位

团队系统为平台提供“团队组织、成员管理与协作”的一体化能力，覆盖团队创建、成员增删改、邀请/申请加入、拥有者转移、团队配置以及解散等全流程，辅以权限边界校验、统一审计与实时通知。

### 1.2 关联模块

- 用户与权限系统：继承平台角色（USER/ADMIN/SUPER_ADMIN），并在团队内引入团队角色（OWNER/ADMIN/MEMBER）。
- 系统配置：团队邀请基础链接、加入申请的限流与幂等 TTL 等。
- 消息通知：关键动作触发站内消息与 WebSocket 事件（成员变更、申请审批等）。

---

## 2. 核心特性

- **单团队约束**: 一个用户同一时间仅能隶属一个团队（避免跨团队权限混淆）。
- **团队内角色模型**: OWNER（拥有者）、ADMIN（管理员）、MEMBER（成员）；平台角色与团队角色相互独立、各司其职。
- **强约束管理规则**:
  - OWNER 不可被移除、不可自行退出、不可被降级或禁用；
  - 仅允许通过“转移拥有者”来变更团队拥有者；
  - 管理员降级/禁用/移除时确保团队仍有 OWNER 或至少一名管理员；
  - 团队禁用后，仅 SUPER_ADMIN 可进行管理写操作。
- **两种入组方式**: 团队邀请（受邀接受）与加入申请（管理员审批）。
- **团队配置**: 支持团队级 KV 配置（如是否开启“加入审批”），统一权限校验与幂等更新。
- **统一审计与通知**: 写操作统一记录操作日志；关键行为通过站内消息与 WS 实时推送。

---

## 3. 角色与权限模型

### 3.1 平台角色（全局）

- **SUPER_ADMIN**: 全局最高权限；可查看/管理所有团队；可设置团队状态（启用/禁用）。
- **ADMIN/USER**: 常规平台角色，团队域内权限由团队角色决定。

### 3.2 团队角色（团队域）

- **OWNER**: 团队拥有者；具有最高团队域权限；可转移拥有者、解散团队；自动获得团队管理相关菜单权限。
- **ADMIN**: 团队管理员；可管理成员、审批加入申请等。
- **MEMBER**: 普通成员；可查看团队详情、退出团队（但非 OWNER）。

### 3.3 访问边界与判定

由 `TeamAccessService` 统一判定：

- canManageTeam(operator, teamId): SUPER_ADMIN 或团队 OWNER/ADMIN 且团队启用。
- canViewTeamForManagement(operator, teamId): SUPER_ADMIN 或团队 OWNER/ADMIN（只读场景不受团队禁用影响）。
- canManageUser(operator, target): 同一启用团队且 operator 为 OWNER/ADMIN，或 SUPER_ADMIN，或本人与本人。
- listManagedUserIds(operator): 返回 operator 在管理边界内可管理的用户集合。

---

## 4. 数据模型

（简要字段为说明用途，详见实体：`Team`、`TeamMember`、`TeamInvitation`、`TeamJoinRequest`、`TeamConfig`）

- **Team**: id、teamName、teamCode（唯一）、ownerUserId、status（ENABLED/DISABLED）、isDeleted、createTime、updateTime。
- **TeamMember**: id、teamId、userId、teamRole（OWNER/ADMIN/MEMBER）、status（ENABLED/DISABLED）、isDeleted、joinedAt。
- **TeamInvitation**: id、teamId、invitationToken、invitedUserId/email/phone、teamRole、expireTime、status（PENDING/ACCEPTED/REJECTED）、acceptedAt。
- **TeamJoinRequest**: id、teamId、userId、teamCode、requestReason、status（PENDING/APPROVED/REJECTED）、processedBy、processedAt、processReason。
- **TeamConfig**: id、teamId、configKey、configValue。

关键约束与索引：

- teamCode 唯一；成员维持“启用且未删”唯一团队约束（服务层校验）。
- 成员逻辑删除用于“复活”避免唯一冲突（移除/退出后可再入组）。

---

## 5. 业务流程

### 5.1 团队创建

1. 登录用户发起创建；
2. 生成唯一 teamCode，插入团队记录；
3. 创建者以 OWNER 身份入组；
4. 授予 OWNER 团队管理菜单权限（team:members、team:join-requests）；
5. 发送“团队创建成功”通知。

### 5.2 成员管理

- 添加成员：禁止直接授予 OWNER；若成员被逻辑删除则“复活”；入组后推送通知。
- 更新成员：禁止更改/禁用 OWNER；管理员降级/禁用需保证仍有 OWNER 或其他管理员。
- 移除成员：禁止移除 OWNER；对最后一名管理员做保护校验；逻辑删除并通知。
- 退出团队：成员可自退，OWNER 不可自退（需先转移或解散）。

### 5.3 拥有者转移

- 仅当前 OWNER 可发起，目标须为启用中的 ADMIN；
- 变更团队记录 ownerUserId，并做角色切换（目标升为 OWNER、原 OWNER 降为 ADMIN）；
- 撤销旧 OWNER 菜单权限并授予新 OWNER；
- 通知新旧拥有者。

### 5.4 团队解散

- 仅 OWNER 可执行；
- 逻辑删除团队并禁用/逻辑删除全部成员关系；
- 通知所有成员；撤销 OWNER 菜单权限。

### 5.5 团队邀请

- 创建邀请：OWNER/ADMIN 可创建，生成 `invitationToken`，默认有效期 7 天；
- 撤回邀请：置为 REJECTED；
- 接受邀请：校验 token/有效期/团队状态，通过则入组或激活成员。

### 5.6 加入申请

- 提交：支持限流与幂等；校验团队启用、非已成员、无待处理申请后创建 PENDING 记录，通知管理员；
- 审批：OWNER/ADMIN 审批；通过则入组或激活成员；拒绝仅归档状态并通知申请人；
- 撤销：申请人可在待处理状态撤销。

### 5.7 团队配置

- 读取/更新 KV：仅管理边界内用户可读写；更新为逐键 upsert，幂等可重入；
- 预置键：`team.join.requireApproval`（是否需要审批，默认 false）。

---

## 6. 系统配置

与团队系统相关的全局配置项（通过 `SystemConfigService` 获取）：

- `TEAM_INVITE_BASE_URL`（邀请基础链接，用于前端拼接完整邀请 URL）；
- `TEAM_JOIN_RATE_LIMIT_PER_MINUTE`（加入申请每分钟限流，默认 6 次）；
- `TEAM_JOIN_IDEMPOTENCY_TTL_SECONDS`（加入申请幂等锁 TTL，默认 30 秒）。

---

## 7. WebSocket 推送与事件

后端在关键动作中通过统一的 WS 处理器推送事件：

- 成员变更：`sendTeamMemberChanged(teamId, userId, action, role)`；
- 加入申请变更：`sendTeamJoinRequestChanged(teamId, requestId, action, operator)`。

前端在相关页面监听事件并“以事件触发 + 补拉数据”的方式保持一致性与幂等。

---

## 8. API 接口说明

说明：所有接口统一使用 `ApiResult<T>` 返回；登录态采用 Sa-Token；权限见注释。

### 8.1 团队管理（`/teams`）

- GET `/teams`：分页查询团队列表（登录；普通用户仅返回所属团队，ADMIN/SUPER_ADMIN 可看更多）。
- POST `/teams`：创建团队（登录；创建者成为 OWNER）。
- GET `/teams/{id}`：获取团队详情（登录；团队启用成员可见）。
- PUT `/teams/{id}`：更新团队信息（登录；OWNER/ADMIN）。
- DELETE `/teams/{id}`：删除团队（软删，登录；OWNER/ADMIN）。
- GET `/teams/preview-by-code`：通过团队码预览（登录）。
- GET `/teams/{id}/members`：成员列表（登录；OWNER/ADMIN）。
- POST `/teams/{id}/members`：添加成员（登录；OWNER/ADMIN）。
- PUT `/teams/{id}/members/{userId}`：更新成员角色/状态（登录；OWNER/ADMIN）。
- DELETE `/teams/{id}/members/{userId}`：移除成员（登录；OWNER/ADMIN）。
- POST `/teams/{id}/transfer-owner`：转移拥有者（登录；仅现 OWNER）。
- POST `/teams/{id}/exit`：退出团队（登录；非 OWNER）。
- POST `/teams/{id}/dissolve`：解散团队（登录；仅 OWNER）。
- PUT `/teams/{id}/status`：设置团队状态（登录+`SUPER_ADMIN`）。

### 8.2 团队邀请（`/team/invitation`）

- POST ``/team/invitation``：创建邀请（登录；OWNER/ADMIN）。
- GET ``/team/invitation/base-url``：获取邀请基础链接（登录）。
- GET ``/team/invitation/{teamId}``：邀请列表（登录；OWNER/ADMIN，分页/过滤）。
- DELETE ``/team/invitation/{id}``：撤回邀请（登录；OWNER/ADMIN）。
- POST ``/team/invitation/accept``：接受邀请（登录）。

### 8.3 加入申请（`/team/join-request`）

- POST ``/team/join-request``：提交加入申请（登录，限流+幂等）。
- GET ``/team/join-request/{teamId}``：申请列表（登录；OWNER/ADMIN，分页/过滤）。
- GET ``/team/join-request/detail/{requestId}``：申请详情（登录；OWNER/ADMIN）。
- POST ``/team/join-request/process``：审批申请（登录；OWNER/ADMIN）。
- DELETE ``/team/join-request/{requestId}``：撤销申请（登录；申请人本人）。

### 8.4 团队配置（`/team/config`）

- GET ``/team/config/{teamId}``：获取团队配置（登录；OWNER/ADMIN）。
- PUT ``/team/config``：更新团队配置（登录；OWNER/ADMIN）。

---

## 9. 安全、异常与审计

### 9.1 统一返回与异常

- 返回类型：`ApiResult<T>`；
- 业务异常：服务层抛出 `ServiceException`，由全局异常处理；
- 错误码：使用 `ErrorCode` 枚举，消息用户友好、按模块语义选择。

### 9.2 事务与并发

- 关键写操作均开启事务（创建团队、成员变更、拥有者转移、解散、邀请/申请处理等）；
- 加入申请内置限流与幂等锁，避免重复与“风暴”；
- 成员关系采用逻辑删除复活策略，避免唯一约束冲突。

### 9.3 审计与操作日志

- 写接口统一使用 `@OperationLog` 记录模块、类型、描述，部分异步写入；
- 关键安全事件（拥有者转移、团队解散、状态切换）重点审计。

### 9.4 权限缓存与菜单授权

- 创建团队/拥有者转移/解散将授予或撤销 OWNER 的团队管理菜单权限，并在事务提交后清理权限缓存，确保前端下次请求生效。

---

## 10. 使用指南

### 10.1 拥有者/管理员

1. 创建团队或从现有团队进入“团队管理”。
2. 通过“成员管理”添加/更新/移除成员；必要时审批加入申请。
3. 通过“团队配置”设置是否需要加入审批等开关。
4. 需变更拥有者时，使用“转移拥有者”。
5. 团队不再需要时，可“解散团队”（不可恢复）。

### 10.2 普通成员

1. 通过邀请或提交加入申请入组；
2. 在团队详情查看团队信息与成员；
3. 需要退出时使用“退出团队”（若为 OWNER，请先转移或解散）。

---

## 11. 技术架构

### 11.1 分层设计

- 表现层：Controller（`TeamController`、`TeamInvitationController`、`TeamJoinRequestController`、`TeamConfigController`）。
- 业务层：Service（`TeamService`、`TeamInvitationService`、`TeamJoinRequestService`、`TeamConfigService`）。
- 安全层：`TeamAccessService` 统一权限边界判定。
- 数据层：MyBatis-Plus（逻辑删除、分页、条件构造）。
- 通知层：`NotificationFacade`（站内信）+ `RealtimeWebSocketHandler`（WS）。

### 11.2 关键实现要点

- 唯一团队码生成与重试；
- 成员“复活”策略与最后管理员保护；
- 拥有者转移的原子切换与菜单权限迁移；
- 团队禁用态的写操作保护与只读放行；
- 加入申请的限流/幂等与审批流；
- 团队配置的幂等更新与最小集键值管理。

---

## 12. 错误码参考

团队域常用错误码（示例，具体以枚举为准）：

- **TEAM_NOT_FOUND**: 团队不存在
- **TEAM_DISABLED**: 团队被禁用
- **TEAM_CODE_INVALID**: 无效的团队码
- **TEAM_MEMBER_NOT_FOUND**: 成员不存在
- **TEAM_MEMBER_ALREADY_EXISTS**: 成员已存在/已在其他团队
- **TEAM_MEMBER_ROLE_INVALID**: 成员角色非法
- **INVITATION_NOT_FOUND / INVITATION_TOKEN_INVALID / INVITATION_EXPIRED / INVITATION_ALREADY_ACCEPTED**: 邀请相关错误
- **JOIN_REQUEST_NOT_FOUND / JOIN_REQUEST_ALREADY_PROCESSED**: 加入申请相关错误
- **TEAM_RATE_LIMITED / TEAM_IDEMPOTENT_REPLAY / TEAM_JOIN_REQUEST_ALREADY_EXISTS**: 流控与幂等错误
- **FORBIDDEN / OPERATION_NOT_ALLOWED / PARAM_INVALID**: 通用权限与参数错误

---

**附注**

- 本文档对应的后端实现位于 `controller/team`、`service/team`、`service/security`、`entity/team`、`mapper/team` 等目录；
- 所有接口严格遵循统一返回与异常处理规范，便于前端一致集成与统一错误处理；
- 前端按“事件触发 + 补拉数据”模式接入团队实时事件，保证一致性与幂等。


