## 团队模型重构方案（一次性重构到位）

### 背景与目标
- 在现有基于 `parentUserId` 的父子账号管理基础上，引入“团队 Team”抽象，统一管理用户分组、边界与授权；支持团队管理员（OWNER/ADMIN）对团队成员进行资源操作和权限下发。
- 一次性重构到位：不做兼容层与迁移灰度；所有越权校验与数据边界均以“团队关系”为准。
- 对齐现有规范：后端严格遵循 `ApiResult<T>` 返回、`ServiceException` 异常抛出、`ErrorCode` 统一管理；不在 Controller 捕获业务异常。
- 新增约束：用户注册后默认不属于任何团队，后续可主动创建团队或通过团队码加入团队。

---

### 范围与影响域
- 受影响模块：用户与权限、积分系统、消息/公告、系统配置、审计日志、WebSocket 推送、（后续）AI 算力/模型授权。
- 代码目录新增：
  - `entity/team/Team.java`, `entity/team/TeamMember.java`
  - `mapper/team/TeamMapper.java`, `mapper/team/TeamMemberMapper.java`
  - `service/team/TeamService.java`, `service/security/TeamAccessService.java`
  - `controller/team/TeamController.java`
- 现有判断 `parentUserId` 的越权逻辑统一替换为团队边界校验。

---

### 角色与权限模型
- 系统角色保留：`USER`, `ADMIN`, `SUPER_ADMIN`。
- 团队内角色：`OWNER`, `ADMIN`, `MEMBER`。
- 鉴权原则：
  - `SUPER_ADMIN`：全局可管理。
  - 团队 `OWNER/ADMIN`：可管理同团队成员与团队资源。
  - `USER`：仅能操作自身资源。
- 菜单/权限编码（示例）：
  - `team:list`, `team:create`, `team:update`, `team:delete`
  - `team:member:list`, `team:member:add`, `team:member:remove`, `team:member:role:update`
  - `team:config:settlement:update`, `team:config:quota:update`

#### 成员归属约束
- 每个用户在任一时刻至多属于一个有效团队（0..1，允许无团队），通过数据库唯一约束与应用层校验共同保证。
- `SUPER_ADMIN` 无需加入任何团队，天然具备全局管理与访问能力。
- 系统角色与团队内角色叠加判断：系统角色（`USER/ADMIN/SUPER_ADMIN`）定义全局能力上限，团队内角色（`OWNER/ADMIN/MEMBER`）限定团队域内的资源操作范围。

---

### 数据库设计

#### 1) 表结构
- `teams`
  - `id` BIGINT PK
  - `team_name` VARCHAR(100) NOT NULL
  - `owner_user_id` BIGINT NOT NULL
  - `status` TINYINT NOT NULL DEFAULT 1  -- 1:启用 0:禁用
  - `description` VARCHAR(255) NULL
  - `is_deleted` TINYINT NOT NULL DEFAULT 0
  - `create_time` DATETIME NOT NULL
  - `update_time` DATETIME NOT NULL
  - 索引：`uk_owner_team_name_active(owner_user_id,team_name,is_deleted)` 唯一，`idx_owner_user_id`，`idx_status`

- `team_members`
  - `id` BIGINT PK
  - `team_id` BIGINT NOT NULL
  - `user_id` BIGINT NOT NULL
  - `team_role` VARCHAR(20) NOT NULL  -- OWNER/ADMIN/MEMBER
  - `status` TINYINT NOT NULL DEFAULT 1
  - `is_deleted` TINYINT NOT NULL DEFAULT 0
  - `create_time` DATETIME NOT NULL
  - `update_time` DATETIME NOT NULL
  - 约束：`uk_team_member`(`team_id`,`user_id`,`is_deleted`) UNIQUE
  - 索引：`idx_team_role`，`idx_user_id`，`idx_team_id`
  - 约束补充（单团队归属）：`uk_team_member_user_active`(`user_id`,`is_deleted`) UNIQUE（同一用户同一时间仅允许存在一条未删除的团队成员关系）

- 可选配置表：`team_configs`
  - `id` BIGINT PK
  - `team_id` BIGINT NOT NULL
  - `config_key` VARCHAR(64) NOT NULL
  - `config_value` VARCHAR(1024) NOT NULL
  - `is_deleted` TINYINT NOT NULL DEFAULT 0
  - `create_time` DATETIME NOT NULL
  - `update_time` DATETIME NOT NULL
  - 约束：`uk_team_config`(`team_id`,`config_key`,`is_deleted`) UNIQUE

- 积分扩展（可选，见下文 settlement）：
  - `team_credits`（团队积分余额表）
  - `team_credit_transactions`（团队积分流水表）

#### 2) DDL 示例（MySQL）
```sql
CREATE TABLE `teams` (
  `id` BIGINT PRIMARY KEY,
  `team_name` VARCHAR(100) NOT NULL,
  `owner_user_id` BIGINT NOT NULL,
  `status` TINYINT NOT NULL DEFAULT 1,
  `description` VARCHAR(255) NULL,
  `is_deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL,
  `update_time` DATETIME NOT NULL,
  UNIQUE KEY `uk_owner_team_name_active` (`owner_user_id`,`team_name`,`is_deleted`),
  KEY `idx_owner_user_id` (`owner_user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `team_members` (
  `id` BIGINT PRIMARY KEY,
  `team_id` BIGINT NOT NULL,
  `user_id` BIGINT NOT NULL,
  `team_role` VARCHAR(20) NOT NULL,
  `status` TINYINT NOT NULL DEFAULT 1,
  `is_deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL,
  `update_time` DATETIME NOT NULL,
  UNIQUE KEY `uk_team_member` (`team_id`,`user_id`,`is_deleted`),
  UNIQUE KEY `uk_team_member_user_active` (`user_id`,`is_deleted`),
  KEY `idx_team_role` (`team_role`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_team_id` (`team_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE `team_configs` (
  `id` BIGINT PRIMARY KEY,
  `team_id` BIGINT NOT NULL,
  `config_key` VARCHAR(64) NOT NULL,
  `config_value` VARCHAR(1024) NOT NULL,
  `is_deleted` TINYINT NOT NULL DEFAULT 0,
  `create_time` DATETIME NOT NULL,
  `update_time` DATETIME NOT NULL,
  UNIQUE KEY `uk_team_config` (`team_id`,`config_key`,`is_deleted`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

### 后端设计与实现

#### 实体与 Mapper
- `entity.team.Team`、`entity.team.TeamMember` 使用 MyBatis-Plus 注解，支持逻辑删除、审计字段自动填充。
- `mapper.team.TeamMapper`、`TeamMemberMapper`：常规 CRUD，批量插入/删除支持。

#### 团队访问边界服务
- `service.security.TeamAccessService`
  - `boolean isSameTeam(Long userIdA, Long userIdB)`
  - `boolean canManageUser(Long operatorId, Long targetUserId)`
  - `List<Long> listManagedUserIds(Long operatorId)`（用于 WHERE IN 过滤）
  - 实现规则（仅识别“有效团队关系”：成员状态启用且团队启用、未删除）：
    - `SUPER_ADMIN`：全局放行
    - `OWNER/ADMIN`：与 `target` 同一有效团队为 true
    - 其他：仅自己

#### 团队服务
- `service.team.TeamService`
  - 团队 CRUD：创建团队（默认 OWNER）、更新、禁用/启用、删除
  - 成员管理：添加/移除成员、变更团队内角色、列出成员
  - 团队配置：结算方式、额度配置、策略开关
  - 审计：记录关键操作日志
  - 关键业务约束：
    - 团队名唯一性范围：同一所有者内唯一（允许平台全局重名）
    - 单团队归属：每个用户同一时间仅属于一个有效团队（依赖唯一索引 `uk_team_member_user_active(user_id,is_deleted)` + 应用层校验）
    - 单一所有者：每个团队仅允许一名 `OWNER`（应用层强校验）
    - 删除团队：同时逻辑删除 `team_members` 关联数据，避免残留活跃成员关系

#### 控制层（仅示例签名，全部返回 `ApiResult<T>`）
- `TeamController`（当前实现路径：`/teams`，由网关或全局前缀组成完整版本化路径）
  - `GET /teams` 列表/分页
  - `POST /teams` 创建
  - `PUT /teams/{id}` 更新（或 `PUT /teams` 携带ID，根据实现）
  - `DELETE /teams/{id}` 删除
  - `GET /teams/{id}/members` 成员列表
  - `POST /teams/{id}/members` 添加成员（或 `POST /teams/members` 携带 teamId）
  - `PUT /teams/{id}/members/{userId}` 变更角色（或 `PUT /teams/members/role` 携带参数）
  - `DELETE /teams/{id}/members/{userId}` 移除成员（或 `DELETE /teams/members` 携带参数）
  - `PUT /teams/{id}/configs` 更新配置（如结算方式/额度）

#### 统一越权改造点（示例）
- 替换原 `parentUserId` 判断：
  - `PermissionManagementServiceImpl.updateUserPermissionOverrides/getUserPermissionOverrides`
  - `UserServiceImpl.updateSubUser/deleteSubUser/toggleSubUserStatus/resetSubUserPassword/getSubUsers`
  - `CreditTransactionServiceImpl.validateAndGetQueryUserId/isSubUser` → 使用 `TeamAccessService`
- 查询范围过滤：支持 `listManagedUserIds(operatorId)` 进行数据范围 WHERE IN 过滤，以避免逐行判断。

#### 错误码新增（1700-1799 用户认证/团队域）
- `TEAM_NOT_FOUND(1771, "团队不存在")`
- `TEAM_FORBIDDEN(1772, "无权访问团队资源")`
- `TEAM_MEMBER_NOT_FOUND(1773, "团队成员不存在")`
- `TEAM_INVALID_ROLE(1774, "无效的团队角色")`
 - `USER_ALREADY_IN_TEAM(1775, "用户已加入团队")`

---

### 积分系统改造与结算方式

#### 1) 查询与权限边界
- 所有查询接口中的用户范围，改为基于 `TeamAccessService`：
  - 普通用户：仅自己
  - 团队 `OWNER/ADMIN`：同团队成员
  - `SUPER_ADMIN`：全量

#### 2) 结算方式（按团队配置）
- `team_configs` 引入键：
  - `CREDIT_SETTLEMENT_MODE`：`USER_ONLY`（默认）、`TEAM_ONLY`、`HYBRID`
  - `CREDIT_TEAM_QUOTA`：团队额度上限（JSON：分积分类型）
  - `CREDIT_OVERDRAFT_ALLOWED`：是否允许透支
- 行为定义：
  - `USER_ONLY`：维持现有用户级余额与流水（无需新增表）。
  - `TEAM_ONLY`：引入 `team_credits`、`team_credit_transactions`，所有扣费/入账在团队侧完成；用户视图为团队侧汇聚。
  - `HYBRID`：用户与团队均维护余额，扣费策略支持：优先团队、优先个人、比例分摊（通过配置阈值/比例实现）。

#### 3) 新表（可选）
- `team_credits`：(`id`,`team_id`,`credit_type_code`,`balance`,`is_deleted`,`create_time`,`update_time`)，唯一 (`team_id`,`credit_type_code`,`is_deleted`)
- `team_credit_transactions`：与用户流水结构类似，含 `related_user_id`/`related_order_id`/`scenario_code` 等字段。

#### 4) 服务改造建议
- 在 `CreditService` 增加结算路由层：根据团队配置决定扣费/入账主体（用户/团队/混合）。
- 出参维持现有 DTO；当团队模式启用时，增加“来源维度”（USER/TEAM/HYBRID）与“承担主体”（teamId/userId）。

---

### 消息通知与公告
- 新增“按团队广播”：公告可指定团队 ID 列表；通知在团队内成员可见。
- WebSocket 推送：当团队配置或团队成员变更时，向团队频道推送变更消息。

---

### 系统配置
- 系统配置项：是否允许用户创建团队、默认团队角色策略、默认结算模式、默认团队额度等。
- 与现有 `SystemConfigService` 兼容，新增键前缀 `TEAM_`、`TEAM_CREDIT_`。
- 新增默认结算配置：`credit.settlement.mode.default`（`USER_ONLY`/`TEAM_ONLY`/`HYBRID`，默认 `USER_ONLY`）。

---

### 团队码与推荐码
- 决策
  - 保留用户推荐码 `users.referral_code` 与 `users.referrer_user_id` 用于拉新归因与奖励，不参与成员关系与权限判定。
  - 不引入一次性“邀请码”机制；成员加入团队仅通过长期有效的 `teamCode` 或由管理员在后台直接添加。

- 数据模型
  - `teams` 可选新增 `team_code` VARCHAR(12) UNIQUE，作为团队加入码（长期码）。

- API 设计（统一 `ApiResult<T>` 返回）
  - `POST /api/v1/auth/register`：注册接口支持可选参数：`teamCode` 与 `referralCode`（二选一）。
    - XOR 规则：`(teamCode != null) XOR (referralCode != null)`；同时填写→报错。
    - `teamCode` 生效：注册完成后尝试加入对应团队为 `MEMBER`（或按配置默认角色）。加入失败不影响注册成功，用户保持“无团队”，并返回明确错误码与消息。
    - `referralCode` 生效：仅记录 `referrer_user_id` 与归因信息，不加入任何团队。
  - `POST /api/v1/teams/{id}/members`：管理员在后台添加成员并指定团队内角色。

- 命名与字段约定
  - `teamCode`：团队码（加入团队的快捷码，源自 `teams.team_code`）。
  - `referralCode`：推荐码（归因用，来源于 `users.referral_code`，不决定团队关系与权限）。
  - 注册页与接口规则：`teamCode` 与 `referralCode` 必须二选一（XOR）。

- 校验与策略
  - 团队码有效性：存在、状态生效、团队未禁用；重复加入时返回已是成员。
  - 加入限制：是否需要 `OWNER` 审批；当用户已有团队时禁止加入其他团队。
  - 安全：团队码为不可预测随机串（8-12 位，大小写+数字）；服务端限流与风控校验。
  - 注册页二选一：若填写了 `teamCode`，则禁用/清空 `referralCode` 输入，反之亦然；后端强校验 XOR。

- 错误码扩展（1700-1799）
  - `TEAM_ALREADY_MEMBER(1778, "已是团队成员")`
  - `TEAM_JOIN_CONFLICT(1779, "团队码与推荐码不可同时填写")`
  - `TEAM_CODE_INVALID(1780, "团队码无效")`

- 前端改造
  - 注册页：新增“团队码 teamCode”和“推荐码 referralCode”（二选一，页面互斥校验）。
    - 用户手填 `teamCode` 时清空并禁用 `referralCode`；
    - 用户手填 `referralCode` 时清空并禁用 `teamCode`；
    - 错误提示与国际化文案对齐后端错误码。
  - 个人中心：展示“我的推荐码/推荐记录”（仅归因展示，与团队成员无直接关系）。

- 与积分/结算联动
  - 推荐奖励：通过 `SystemConfigService` 配置 `TEAM_REFERRAL_REWARD_*` 与 `USER_REFERRAL_REWARD_*` 策略，奖励对象可配置为个人或团队余额（依据团队结算模式）。
  - 入团后：若团队结算为 `TEAM_ONLY`，仅对后续消费生效（不进行个人余额迁移）。

- 系统配置建议键
  - `TEAM_REFERRAL_REWARD_ENABLED`
  - `USER_REFERRAL_REWARD_ENABLED`
  - `TEAM_CODE_REQUIRE_APPROVAL`
  - `TEAM_CODE_DEFAULT_ROLE`  （默认 `MEMBER`）

---

## 接口清单与实现说明（一）- 总则

- 范围：本节定义后端对外 API 的完整清单与实现要点，覆盖 Auth/User、Team、Membership（加入/审批）、Context（当前团队上下文）、Credit（积分视图与结算相关），以及非 API 层面的受影响点与代码位置。
- 统一返回：所有 Controller 必须返回 `ApiResult<T>`；业务错误只抛 `ServiceException`；错误码统一来自 `ErrorCode`，团队/用户域错误码区间 `1700-1799`。
- 鉴权与边界：登录校验后，通过 `TeamAccessService` 实施团队域越权判断；跨团队访问一律禁止；`SUPER_ADMIN` 全局放行。
- 参数校验：`@Valid` + DTO；复杂校验使用 `ServiceException.paramInvalid(msg)`；接口参数>2 使用 DTO 封装。
- 幂等性：创建/加入类接口支持幂等键 `idempotencyKey`（可选）；批量写入使用乐观锁/行锁保障一致性。
- 审计与日志：关键写操作记录操作者、来源、请求ID；失败记录错误码与上下文；事务提交后发布事件与 WebSocket 推送。
- 事务：涉及多表写入的方法使用 `@Transactional(rollbackFor = Exception.class)`；扣费/入账需保证原子性与版本号校验。
- 错误码：常用 `TEAM_NOT_FOUND(1771)`、`TEAM_FORBIDDEN(1772)`、`TEAM_MEMBER_NOT_FOUND(1773)`、`TEAM_INVALID_ROLE(1774)`、`USER_ALREADY_IN_TEAM(1775)`、`TEAM_ALREADY_MEMBER(1778)`、`TEAM_JOIN_CONFLICT(1779)`、`TEAM_CODE_INVALID(1780)`。

---

## 接口清单与实现说明（二）- Auth / User

### 1) 注册（可受 teamCode 影响）
- 方法与路径：POST `/api/v1/auth/register`
- 作用：创建用户账号；若携带有效 `teamCode`，注册成功后尝试加入对应团队；加入失败不影响注册成功。
- 请求体（最小示例，实际以 DTO 为准）：`username`、`password`、`email`、可选 `teamCode`、可选 `referralCode`（XOR 二选一）
- 返回：`ApiResult<UserVO>`（不包含敏感字段）
- 主要错误码：
  - `PARAM_INVALID(1000+)` 参数校验失败
  - `TEAM_JOIN_CONFLICT(1779)` 同时提供 `teamCode` 与 `referralCode`
  - `TEAM_CODE_INVALID(1780)` 团队码无效（加入失败，仅提示，不回滚注册）
  - `USER_ALREADY_IN_TEAM(1775)` 注册成功但加入失败（例如后台判定已有团队）
- 实现逻辑（Service）：
  1. 参数与唯一性校验
  2. 创建用户与登录态初始化
  3. 若存在 `teamCode`：校验团队状态/团队码 → 尝试加入（默认 `TEAM_CODE_DEFAULT_ROLE`；若 `TEAM_CODE_REQUIRE_APPROVAL` 则生成 PENDING 申请）→ 失败仅记录并在响应附提示码
  4. 审计日志
- 代码位置：
  - `controller.auth.AuthController.register`
  - `service.auth.AuthServiceImpl.registerWithTeamCode`
  - `service.team.TeamJoinService.joinByCode`

### 2) 登录
- 方法与路径：POST `/api/v1/auth/login`
- 作用：校验凭证并颁发 token；不变更团队上下文。
- 请求体：`{"usernameOrEmail":"alice","password":"****"}`
- 返回：`ApiResult<LoginVO>`（含 `token` 与用户基本信息）
- 代码位置：`controller.auth.AuthController.login`，`service.auth.AuthServiceImpl.login`

### 3) 获取当前用户信息（含当前团队上下文）
- 方法与路径：GET `/api/v1/users/me`
- 作用：返回当前登录用户信息与“当前团队上下文”（可为空）。
- 返回：`ApiResult<UserProfileVO>`
- 实现逻辑：读取用户 + 读取/推断当前上下文团队（来自 `UserContextService` 或最近一次选择）。
- 代码位置：`controller.user.UserController.me`，`service.user.UserService.getProfile`，`service.user.UserContextService`

### 4) 获取我的团队列表
- 方法与路径：GET `/api/v1/users/me/teams`
- 作用：列出当前用户可访问的团队（自身归属团队 + 管理员可管理团队）。
- 返回：`ApiResult<List<TeamSummaryVO>>`
- 实现逻辑：以成员表查询（状态=ACTIVE）并附带团队内角色。
- 代码位置：`controller.user.UserController.listMyTeams`，`service.team.TeamQueryService.listTeamsByUser`

---

## 接口清单与实现说明（三）- Team（团队）

### 1) 列表/分页
- 方法与路径：GET `/api/v1/teams`
- 作用：分页查询团队（管理员/超级管理员可见范围更大；普通用户返回自己所属团队）。
- 入参（示例）：`pageNum`、`pageSize`、`keyword`
- 返回：`ApiResult<Page<TeamVO>>`
- 权限：`ADMIN`/`SUPER_ADMIN` 可查询多团队；普通 `USER` 仅返回所属团队。
- 代码位置：`controller.team.TeamController.list`，`service.team.TeamService.page`

### 2) 创建团队
- 方法与路径：POST `/api/v1/teams`
- 作用：创建团队并将创建者设为 `OWNER`。
- 入参 DTO：`CreateTeamRequest`（`teamName`,`description`...）
- 校验：同一 `owner_user_id` 下团队名唯一；对齐唯一索引 `uk_owner_team_name_active`。
- 返回：`ApiResult<TeamDetailVO>`
- 错误码：`PARAM_INVALID`、`TEAM_FORBIDDEN`
- 代码位置：`controller.team.TeamController.create`，`service.team.TeamService.createTeam`

### 3) 获取团队详情
- 方法与路径：GET `/api/v1/teams/{id}`
- 作用：查看团队基本信息与配置摘要。
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 返回：`ApiResult<TeamDetailVO>`
- 代码位置：`TeamController.detail`，`TeamService.getDetail`

### 4) 更新团队
- 方法与路径：PUT `/api/v1/teams/{id}`
- 作用：更新团队基本信息。
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 入参 DTO：`UpdateTeamRequest`
- 返回：`ApiResult<Void>`
- 代码位置：`TeamController.update`，`TeamService.updateTeam`

### 5) 删除团队
- 方法与路径：DELETE `/api/v1/teams/{id}`
- 作用：逻辑删除团队及其成员关系（软删）。
- 权限：`OWNER` 或 `SUPER_ADMIN`。
- 返回：`ApiResult<Void>`
- 代码位置：`TeamController.delete`，`TeamService.deleteTeam`

### 6) 获取/更新团队配置
- 方法与路径：
  - GET `/api/v1/teams/{id}/configs`
  - PUT `/api/v1/teams/{id}/configs`
- 作用：读取/更新团队配置（如 `CREDIT_SETTLEMENT_MODE`、额度、策略开关）。
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 入参 DTO：`UpdateTeamConfigRequest`（键值对或结构化字段）
- 返回：`ApiResult<TeamConfigVO>` / `ApiResult<Void>`
- 代码位置：`TeamController.getConfigs`/`updateConfigs`，`TeamService.getConfigs`/`saveConfigs`

### 7) 成员列表（只读）
- 方法与路径：GET `/api/v1/teams/{id}/members`
- 作用：列出团队成员及其团队内角色、状态。
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 返回：`ApiResult<Page<TeamMemberVO>>`
- 代码位置：`TeamController.listMembers`，`TeamService.listMembers`

---

## 接口清单与实现说明（四）- Membership（加入/成员管理/审批）

### 1) 用户自助：通过团队码加入
- 方法与路径：POST `/api/v1/teams/join-by-code`
- 作用：用户输入 `teamCode` 申请加入团队。
- 入参 DTO：`JoinByCodeRequest`（`teamCode`）
- 返回：`ApiResult<Void>` 或 `ApiResult<JoinResultVO>`（含是否 PENDING）
- 错误码：`TEAM_CODE_INVALID(1780)`、`USER_ALREADY_IN_TEAM(1775)`、`TEAM_ALREADY_MEMBER(1778)`、`TEAM_FORBIDDEN(1772)`
- 逻辑：校验团队码 → 若需审批则创建 PENDING 申请 → 否则直接建立成员关系。
- 代码位置：`controller.team.MembershipController.joinByCode`，`service.team.TeamJoinService.joinByCode`

### 2) 管理员：直接添加成员
- 方法与路径：POST `/api/v1/teams/{id}/members`
- 作用：管理员在后台添加成员并指定团队内角色。
- 入参 DTO：`AddMemberRequest`（`userId`,`role`）
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 错误码：`TEAM_INVALID_ROLE(1774)`、`USER_ALREADY_IN_TEAM(1775)`、`TEAM_ALREADY_MEMBER(1778)`
- 代码位置：`TeamController.addMember`，`TeamService.addMember`

### 3) 管理员：移除成员
- 方法与路径：DELETE `/api/v1/teams/{id}/members/{userId}`
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 返回：`ApiResult<Void>`
- 代码位置：`TeamController.removeMember`，`TeamService.removeMember`

### 4) 管理员：变更成员角色/状态
- 方法与路径：PUT `/api/v1/teams/{id}/members/{userId}`
- 入参 DTO：`UpdateMemberRequest`（`role`/`status`）
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 错误码：`TEAM_INVALID_ROLE(1774)`
- 代码位置：`TeamController.updateMember`，`TeamService.updateMember`

### 5) 审批流（当 `TEAM_CODE_REQUIRE_APPROVAL`=true）
- 方法与路径：
  - GET `/api/v1/teams/{id}/join-requests` 列表
  - POST `/api/v1/teams/{id}/join-requests/{requestId}/approve`
  - POST `/api/v1/teams/{id}/join-requests/{requestId}/reject`
- 作用：管理员审核加入申请。
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 代码位置：`MembershipController.listJoinRequests/approve/reject`，`TeamJoinService`

---

## 接口清单与实现说明（五）- Context（当前团队上下文）

### 1) 获取当前上下文团队
- 方法与路径：GET `/api/v1/context/team`
- 作用：返回当前登录用户的“当前团队上下文”（可为空）。
- 返回：`ApiResult<ContextTeamVO>`
- 代码位置：`controller.context.ContextController.getContextTeam`，`service.user.UserContextService.get`

### 2) 切换当前上下文团队
- 方法与路径：PUT `/api/v1/context/team/{teamId}`
- 作用：设置当前会话/账户的上下文团队（需校验用户属于该团队）。
- 返回：`ApiResult<Void>`
- 错误码：`TEAM_NOT_FOUND(1771)`、`TEAM_FORBIDDEN(1772)`
- 代码位置：`ContextController.setContextTeam`，`UserContextService.set`

### 3) 清除上下文团队
- 方法与路径：DELETE `/api/v1/context/team`
- 作用：清除当前上下文（回退为“仅个人域”）。
- 返回：`ApiResult<Void>`
- 代码位置：`ContextController.clearContextTeam`，`UserContextService.clear`

---

## 接口清单与实现说明（六）- Credit（积分视图与结算相关）

说明：积分结算的“扣费/入账”由服务层路由完成，外部 API 以“查询与管理”为主；管理员侧支持团队维度查询与充值/发放。

### 1) 查询当前用户的积分视图
- 方法与路径：GET `/api/v1/credits/me`
- 作用：在当前上下文下返回用户可见的积分汇总与承担主体（USER/TEAM/HYBRID）。
- 返回：`ApiResult<UserCreditViewVO>`（含 subjectType、subjectId、各积分类型余额）
- 代码位置：`controller.credit.CreditController.getMyCredits`，`service.credit.CreditService.getCreditViewForCurrentContext`

### 2) 查询团队积分（管理员）
- 方法与路径：GET `/api/v1/teams/{id}/credits`
- 作用：团队维度的积分余额视图。
- 权限：团队 `OWNER/ADMIN` 或 `SUPER_ADMIN`。
- 返回：`ApiResult<TeamCreditsVO>`
- 代码位置：`CreditController.getTeamCredits`，`CreditService.getTeamCredits`

### 3) 查询积分流水
- 方法与路径：
  - GET `/api/v1/credits/transactions`（按 subjectType=USER|TEAM 与 subjectId 过滤）
  - 或 GET `/api/v1/teams/{id}/credits/transactions`
- 作用：分页查询积分流水，支持时间/类型/场景过滤。
- 返回：`ApiResult<Page<CreditTransactionVO>`
- 代码位置：`CreditController.listTransactions`，`CreditTransactionService.listBySubject`

### 4) 充值/发放（运营/管理员）
- 方法与路径：POST `/api/v1/credits/grant`
- 入参 DTO：`GrantCreditRequest`（`subjectType`=USER|TEAM, `subjectId`, `creditTypeCode`, `amount`, `idempotencyKey`）
- 作用：向用户/团队发放积分；支持幂等键。
- 权限：`ADMIN`/`SUPER_ADMIN` 或具备相应运营权限。
- 返回：`ApiResult<Void>`
- 代码位置：`CreditController.grant`，`CreditService.grant`

### 5) 扣费/核销（服务内部）
- 非 API：由计算/订单等业务在服务层调度，依据团队配置路由到 USER_ONLY / TEAM_ONLY / HYBRID。
- 代码位置：`service.credit.CreditService`、`impl.CreditServiceImpl`（新增路由层与 TEAM_ONLY/HYBRID 对应 DAO）

---

## 非 API 影响与代码位置（实现逻辑说明）

- `service.security.TeamAccessService`
  - 作用：统一的团队边界与管理范围判定；提供 `isSameTeam/canManageUser/listManagedUserIds`。
  - 影响：替换原有基于 `parentUserId` 的所有越权判断与范围过滤。

- 权限与子账号相关改造
  - `service.permission.impl.PermissionManagementServiceImpl`：所有“操作人-目标用户”校验改为 `TeamAccessService.canManageUser`。
  - `service.permission.impl.PermissionServiceImpl`：去除 `parentUserId` 依赖，改为团队边界。
  - `service.user.impl.UserServiceImpl` / `controller.user.UserController`：子账号接口 `@Deprecated` 或迁移到 `TeamController` 对应路由。

- 积分系统
  - `service.credit.impl.CreditServiceImpl`：新增“结算路由层”，按 `team_configs.CREDIT_SETTLEMENT_MODE` 或系统 `credit.settlement.mode.default` 在 USER_ONLY/TEAM_ONLY/HYBRID 间路由。
  - `service.credit.impl.CreditTransactionServiceImpl`：查询/权限改为基于团队边界；增加 TEAM_ONLY/HYBRID DAO 对接。

- 日志与审计
  - `service.log.impl.UserLogServiceImpl`：子账号过滤替换为团队成员 ID 集合 IN 过滤。
  - WebSocket：新增 `TOPIC_TEAM_CHANGED`，变更在事务提交后推送。

- 系统配置
  - `SystemConfigKeys`：新增 `credit.settlement.mode.default`；团队配置键前缀 `TEAM_`、`TEAM_CREDIT_`。
  - `controller.system.SystemConfigController`：开放上述键的维护能力。

以上接口均需遵循：Controller 仅返回 `ApiResult<T>`；业务异常抛 `ServiceException`；错误码来自 `ErrorCode` 统一管理。

---

### 兼容性与运行保障
- 迁移前置校验
  - 数据自检：用户表、子账号关系、历史权限是否能映射到团队模型；输出潜在异常数据清单。
- 回滚策略
  - 表新增不破坏旧逻辑；保留用户侧 API，不依赖团队也可工作。

---

- 用户与认证（auth/user）
  - 注册：新增 `teamCode/referralCode` XOR；注册后不创建团队。若携带 `teamCode` 且有效则尝试加入目标团队；失败不影响注册。
  - 登录：不变；若用户有团队，登录后可选择“当前上下文团队”，影响后续列表默认过滤与操作边界；无团队时仅可进行个人域操作。
  - 用户档案：展示所属团队与角色（可能为空）。
- 权限与菜单（permission）
  - 统一通过 `TeamAccessService` 做边界判断，替换历史 `parentUserId` 判断。
  - 菜单可见性与按钮权限基于团队内角色与系统角色组合判定。
- 积分系统（credit）
  - 结算路由：依据团队配置在 USER/TEAM/HYBRID 间路由；保证事务一致性与余额原子更新。
  - 视图：列表支持团队维度与用户维度切换；流水增加承担主体标识。
- 消息/公告（message/notice）
  - 支持按团队广播；历史全量公告仍可按系统级广播。
- 审计日志（audit）
  - 记录团队创建/成员增删/角色变更/配置变更；含操作者、团队、成员、前后值。
- WebSocket 推送
  - 引入团队频道，成员变更/配置变更时向频道推送增量。
- AI 模型与任务（后续）
  - 训练/推理任务挂载团队主体；队列隔离与额度扣减遵循结算模式。
- 报表统计
  - 增加团队维度的用量、费用、产出统计；支持按团队导出。

---

### 监控与告警
- 指标（Metrics）
  - 团队：创建数、禁用数、活跃团队数、平均团队规模。
  - 团队码加入：输入次数、加入成功率、并发冲突率、无效码比例。
  - 结算：TEAM_ONLY/HYBRID 请求占比、扣费失败率、余额不足率。
  - 越权：被拒绝请求数、灰度期告警数（`TEAM_ENFORCE_BOUNDARY=false`）。
- 日志与追踪
  - 关键路径埋点 TraceId；接受邀请/加入团队的耗时与失败原因打点。
- 告警
  - 阈值：团队码加入失败率>5%、越权拒绝激增、余额扣费异常波动；触发通知与自动降级（例如临时禁用团队码加入功能）。

---

### 审计与安全
- 关键操作：团队创建/删除、成员增删/角色变更、结算模式切换、额度调整；记录操作者、目标团队/成员、前后值快照。
- 日志分级：`INFO` 业务成功，`WARN` 边界与策略异常，`ERROR` 未知异常。

---

### 前端改造
- 菜单
  - 新增：团队管理（仅 `ADMIN`/`SUPER_ADMIN` 可见）。
- 页面
  - 团队列表/详情页：基础信息、成员列表与角色管理、团队配置（结算方式/额度）、变更历史。
  - 用户列表：改为“团队成员列表”；支持团队筛选与批量操作。
  - 积分页：支持切换视图（用户维度/团队维度），展示承担主体与结算模式提示。
- 权限点：与后端权限编码对齐。

---

### 迁移与数据初始化（一次性上线）
- 由于允许一次性切换：
  - 清理或忽略 `parentUserId` 语义；不再用于越权校验。
  - 初始化：
    - 为每个 `ADMIN` 创建一个团队并设为 `OWNER`；将其历史“子账号”加入团队为 `MEMBER`（如需要保留管理范围）。
    - 不为普通 `USER` 批量创建“个人团队”。
    - `SUPER_ADMIN` 可加入“系统团队”或不加入，按运营策略定。
  - 若无需保留历史从属关系，可跳过“子账号回填”。

---

### 开发任务分解（后端）
1. 新建实体与表：Team/TeamMember/TeamConfig + DDL
2. 新建 TeamAccessService 并覆盖原越权校验调用点
3. 新建 TeamService + TeamController（CRUD、成员与配置）
4. 积分服务增加结算路由，支持 USER_ONLY/TEAM_ONLY/HYBRID
5. 公告/通知支持按团队广播（可先后端 API，前端随后）
6. 审计日志记录关键变更

---

### 代码规范与实现注意事项（参考 development-standards.mdc）
- 统一返回与异常：Controller 仅返回 `ApiResult<T>`；业务错误抛 `ServiceException`；错误码集中于 `ErrorCode`，按模块区间新增。
- 命名与结构：遵循阿里规约与统一包结构；模块化目录：`entity/team`、`mapper/team`、`service/team`、`controller/team`；禁止在 Mapper 使用注解式 SQL。
- 参数与校验：Controller 参数>2 使用 DTO 封装；`@Valid` 触发校验；手动校验失败抛 `ServiceException.paramInvalid(...)`。
- 事务与一致性：跨表写入使用 `@Transactional(rollbackFor=Exception.class)`；余额更新使用乐观锁或行级锁；写后推送 WebSocket 事件需在事务提交后发布。
- 日志与安全：记录关键操作 `INFO`，越权/策略异常 `WARN`，未知异常 `ERROR`；避免记录敏感信息（密码/支付/密钥）。
- 数据访问：复杂查询优先 MyBatis-Plus Wrapper；范围过滤统一使用 `TeamAccessService.listManagedUserIds` 构造 IN 条件。
- 单元/集成测试：覆盖团队单归属、SUPER_ADMIN 越权放行、ADMIN/OWNER 团队内管理、三种结算模式路由与并发一致性用例。
- 注释与日志：实体类、DTO、VO、Service接口和实现类、Controller等所有代码中都需要加上详细的注释，包括字段、方法、类级别和关键逻辑代码位置，另外需要在必要位置加上日志输出。
---

### 验收与测试
- 单元测试：TeamAccessService 边界、TeamService CRUD、权限越权、结算路由。
- 集成测试：团队成员管理流、积分扣费多模式回归、权限树与菜单可见性。
- 回滚方案：表独立、功能可通过系统开关关闭团队创建入口；结算路由可回退到 USER_ONLY。

---

### 备注
- 全面遵循 `ApiResult<T>`、`ServiceException`、`ErrorCode` 规范。
- 错误消息对用户友好，避免技术细节泄露。
- 代码风格与模块化目录严格与现有项目一致。

---

### 改动清单与SQL方案（基于当前代码）

#### 一、代码改动清单

1) 用户与子账号相关（移除 parentUserId 语义，切换到团队边界）
- `entity.auth.User`：保留 `parentUserId` 字段以兼容历史数据，但业务判定不再依赖；后续数据迁移后可下线。
- `service.user.UserService` / `impl.UserServiceImpl`
  - 下线或改造以下方法：`getSubUsers`、`createSubUser`、`updateSubUser`、`deleteSubUser`、`toggleSubUserStatus`、`resetSubUserPassword`
    - 新增 `TeamService` 能力后，管理员在团队维度进行成员管理；上述接口将迁移为：
      - `GET /api/v1/teams/{id}/members` 列表 → 替代 `getSubUsers`
      - `POST /api/v1/teams/{id}/members` 添加成员 → 替代 `createSubUser`
      - `PUT /api/v1/teams/{id}/members/{userId}` 更新成员角色/状态 → 替代 `updateSubUser`/`toggleSubUserStatus`
      - `DELETE /api/v1/teams/{id}/members/{userId}` 移除成员 → 替代 `deleteSubUser`
    - `resetSubUserPassword`：保留为“团队成员密码重置”，需在 `TeamAccessService.canManageUser` 通过团队边界校验。
- `controller.user.UserController`：对应路由标注为“废弃（Deprecated）”，文档指向新的 `TeamController` 路由；或直接下线并由前端改路由。

2) 权限管理（由 parent_user 边界改为团队边界）
- `service.permission.impl.PermissionManagementServiceImpl`
  - 所有“操作人-目标用户”的校验：由 `target.parentUserId == operatorId` 改为 `TeamAccessService.canManageUser(operatorId, targetUserId)`。
  - 读取/配置用户权限覆盖的接口同理替换边界校验。

3) 积分系统（查询范围与扣费主体）
- `service.credit.impl.CreditServiceImpl`
  - 替换 `getAllSubUserIds(currentUserId)` 与基于 `parentUserId` 的可见范围，改为：
    - `List<Long> visibleUserIds = TeamAccessService.listManagedUserIds(currentUserId)`；普通用户返回 `[currentUserId]`。
  - 结算路由层：按 `team_configs.CREDIT_SETTLEMENT_MODE`（或系统 `CREDIT_SETTLEMENT_MODE_DEFAULT`）在 USER_ONLY / TEAM_ONLY / HYBRID 之间路由。
    - TEAM_ONLY：读写 `team_credits` 与 `team_credit_transactions`。
    - HYBRID：策略化扣费（优先团队/优先个人/比例），配置来源 `team_configs`。
- `service.credit.impl.CreditTransactionServiceImpl`
  - 查询权限 `isSubUser`/`parentUserId` 相关逻辑，替换为 `TeamAccessService.canManageUser(currentUserId, requestUserId)`。

4) 权限服务（辅助判定）
- `service.permission.impl.PermissionServiceImpl` 中基于 `target.getParentUserId()` 的判断改为团队边界判定或直接依赖 `TeamAccessService`。

5) 用户日志与其他引用点
- `service.log.impl.UserLogServiceImpl` 查询子账号日志的 `parentUserId` 条件改为基于 `TeamAccessService.listManagedUserIds(currentUserId)` 构造 IN 条件。

6) 注册与推荐码（增加 teamCode/referralCode XOR）
- `controller.auth.AuthController` / `service.auth.impl.AuthServiceImpl`
  - `UserRegisterRequest` 增加 `teamCode` 可选字段，服务端强校验 XOR：`(teamCode != null) XOR (referralCode != null)`。
  - 当 `teamCode` 有效：注册成功后自动加入对应团队为 `MEMBER`（或按系统配置 `TEAM_CODE_DEFAULT_ROLE` 设置默认角色），可选是否需审批 `TEAM_CODE_REQUIRE_APPROVAL`。
  - 推荐码逻辑保持归因与奖励，不影响团队关系。

7) 系统配置
- `SystemConfigKeys`：新增 `CREDIT_SETTLEMENT_MODE_DEFAULT`（字符串：USER_ONLY/TEAM_ONLY/HYBRID）。
- `service.system.SystemConfigService`：无需变更接口，落地新增键读写与默认值。
- `controller.system.SystemConfigController`：在配置管理界面增加上述键的维护能力。

8) 新增团队域能力（新增文件）
- `entity.team.Team`、`entity.team.TeamMember`、`entity.team.TeamConfig`
- `mapper.team.TeamMapper`、`TeamMemberMapper`、`TeamConfigMapper`
- `service.security.TeamAccessService`（边界判定与可见范围）
- `service.team.TeamService` + `controller.team.TeamController`

9) WebSocket 推送
- 团队成员/配置变更后，新增团队频道推送：与现有 `RealtimeWebSocketHandler` 类似，新增 `TOPIC_TEAM_CHANGED`。

10) 错误码
- 在 `ErrorCode` 中按 1700-1799 区间增加：`TEAM_NOT_FOUND`、`TEAM_FORBIDDEN`、`TEAM_MEMBER_NOT_FOUND`、`TEAM_INVALID_ROLE`、`TEAM_ALREADY_MEMBER`、`TEAM_JOIN_CONFLICT`、`TEAM_CODE_INVALID`。

#### 二、具体文件-行级改造指引（示例）

- `service.credit.impl.CreditServiceImpl`
  - 替换：`getAllSubUserIds` 全部调用方 → 使用 `TeamAccessService.listManagedUserIds`。
  - 删除/保留兼容：`getAllSubUserIds` 方法，改为私有包装或删除。
- `service.credit.impl.CreditTransactionServiceImpl`
  - 替换：`isSubUser` 判定 → `TeamAccessService.canManageUser`；移除对 `parentUserId` 的直接查询。
- `service.permission.impl.PermissionManagementServiceImpl`
  - 替换多处针对 `target.getParentUserId()` 的越权校验为团队边界校验。
- `service.permission.impl.PermissionServiceImpl`
  - 替换基于 `parentUserId` 的 ADMIN 判定逻辑。
- `service.user.impl.UserServiceImpl` / `controller.user.UserController`
  - 标记相关子账号接口 `@Deprecated`，并在路由文档提示改用 `TeamController`。
- `service.log.impl.UserLogServiceImpl`
  - 替换 `User::getParentUserId` 过滤为团队成员 ID 集合过滤。
- `dto.auth.request.UserRegisterRequest`
  - 新增 `private String teamCode;`，在 `cleanAndNormalize()` 与参数校验中加入 XOR 校验。

#### 三、数据库与SQL方案（init.sql 追加/修改）

1) 新增团队相关表
```sql
-- teams
CREATE TABLE IF NOT EXISTS `teams` (
  `id` bigint PRIMARY KEY,
  `team_name` varchar(100) NOT NULL,
  `owner_user_id` bigint NOT NULL,
  `status` tinyint NOT NULL DEFAULT 1,
  `description` varchar(255) DEFAULT NULL,
  `is_deleted` tinyint NOT NULL DEFAULT 0,
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_owner_team_name_active` (`owner_user_id`,`team_name`,`is_deleted`),
  KEY `idx_owner_user_id` (`owner_user_id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='团队表';

-- team_members
CREATE TABLE IF NOT EXISTS `team_members` (
  `id` bigint PRIMARY KEY,
  `team_id` bigint NOT NULL,
  `user_id` bigint NOT NULL,
  `team_role` varchar(20) NOT NULL,
  `status` tinyint NOT NULL DEFAULT 1,
  `is_deleted` tinyint NOT NULL DEFAULT 0,
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_team_member` (`team_id`,`user_id`,`is_deleted`),
  UNIQUE KEY `uk_team_member_user_active` (`user_id`,`is_deleted`),
  KEY `idx_team_role` (`team_role`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_team_id` (`team_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='团队成员表';

-- team_configs
CREATE TABLE IF NOT EXISTS `team_configs` (
  `id` bigint PRIMARY KEY,
  `team_id` bigint NOT NULL,
  `config_key` varchar(64) NOT NULL,
  `config_value` varchar(1024) NOT NULL,
  `is_deleted` tinyint NOT NULL DEFAULT 0,
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_team_config` (`team_id`,`config_key`,`is_deleted`),
  KEY `idx_team_id` (`team_id`),
  KEY `idx_config_key` (`config_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='团队配置表';
```

2) 可选：团队积分表（TEAM_ONLY/HYBRID 时启用）
```sql
CREATE TABLE IF NOT EXISTS `team_credits` (
  `id` bigint PRIMARY KEY,
  `team_id` bigint NOT NULL,
  `credit_type_code` varchar(50) NOT NULL,
  `balance` decimal(10,2) NOT NULL DEFAULT '0.00',
  `total_earned` decimal(10,2) NOT NULL DEFAULT '0.00',
  `total_consumed` decimal(10,2) NOT NULL DEFAULT '0.00',
  `version` int NOT NULL DEFAULT '0',
  `is_deleted` tinyint NOT NULL DEFAULT '0',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_team_credits_active` (`team_id`,`credit_type_code`,`is_deleted`),
  KEY `idx_team_credits_team_id` (`team_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='团队积分账户表';

CREATE TABLE IF NOT EXISTS `team_credit_transactions` (
  `id` bigint PRIMARY KEY,
  `team_id` bigint NOT NULL,
  `credit_type_code` varchar(50) NOT NULL,
  `transaction_type` varchar(30) NOT NULL,
  `amount` decimal(10,2) NOT NULL,
  `balance_before` decimal(10,2) NOT NULL,
  `balance_after` decimal(10,2) NOT NULL,
  `related_user_id` bigint DEFAULT NULL,
  `related_order_id` varchar(50) DEFAULT NULL,
  `related_transaction_id` bigint DEFAULT NULL,
  `scenario_code` varchar(50) DEFAULT NULL,
  `description` varchar(200) DEFAULT NULL,
  `is_deleted` tinyint NOT NULL DEFAULT '0',
  `create_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `update_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  KEY `idx_team_credit_tx_team` (`team_id`),
  KEY `idx_team_credit_tx_scenario` (`scenario_code`),
  KEY `idx_team_credit_tx_type_time` (`transaction_type`, `create_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='团队积分交易表';
```

3) 系统配置新增键（默认值）
```sql
INSERT INTO `system_configs` (`id`, `config_key`, `config_value`, `config_type`, `config_type_code`, `config_category`, `config_category_code`, `description`, `status`, `sort_order`) VALUES
  (1001, 'credit.settlement.mode.default', 'USER_ONLY', 'STRING', 'DICT_3.2', 'SYSTEM', 'DICT_1.8', '默认结算模式(USER_ONLY/TEAM_ONLY/HYBRID)', 1, 50)
ON DUPLICATE KEY UPDATE `config_value`=VALUES(`config_value`), `description`=VALUES(`description`);
```

4) 错误码追加（若未存在）
```sql
-- ErrorCode 为应用内枚举，不直接建表；此处仅作为规范记录
-- 在枚举中新增：TEAM_NOT_FOUND(1771), TEAM_FORBIDDEN(1772), TEAM_MEMBER_NOT_FOUND(1773), TEAM_INVALID_ROLE(1774), TEAM_ALREADY_MEMBER(1778), TEAM_JOIN_CONFLICT(1779), TEAM_CODE_INVALID(1780)
```

5) 初始化与迁移建议（包含初始用户与团队示例数据）
- 规则：
  - `SUPER_ADMIN` 不加入任何团队（保持全局域管理能力）。
  - 为每个 `ADMIN` 初始化一个团队并设为 `OWNER`。
  - 将历史 `parent_userId`=ADMIN 的用户批量加入其团队为 `MEMBER`。
  - 不为普通 `USER` 批量创建“个人团队”。
```sql
-- 示例：创建管理员默认团队（演示语句，实际需程序化迁移以保证幂等与日志）
INSERT INTO teams (`id`,`team_name`,`owner_user_id`,`status`,`is_deleted`,`create_time`,`update_time`)
SELECT (200000 + u.id) AS id, CONCAT('AdminTeam-', u.username) AS team_name, u.id AS owner_user_id, 1, 0, NOW(), NOW()
FROM users u WHERE u.role='ADMIN' AND u.is_deleted=0
ON DUPLICATE KEY UPDATE team_name=VALUES(team_name);

-- 将其子账号迁移为团队成员
INSERT INTO team_members (`id`,`team_id`,`user_id`,`team_role`,`status`,`is_deleted`,`create_time`,`update_time`)
SELECT (300000 + s.id) AS id, (200000 + a.id) AS team_id, s.id AS user_id, 'MEMBER', 1, 0, NOW(), NOW()
FROM users s
JOIN users a ON s.parent_user_id=a.id AND a.role='ADMIN'
WHERE s.is_deleted=0
ON DUPLICATE KEY UPDATE team_role='MEMBER', status=1;

-- 已移除：批量为普通 USER 创建个人团队的初始化脚本（默认不创建）
```

6) 索引与性能
- 为 `team_members(team_id,user_id,is_deleted)` 建唯一索引（已包含）。
- 为 `team_credit_transactions(team_id,scenario_code,create_time)` 建组合索引覆盖常用查询。

以上改动完成后，代码中的权限与数据边界将以“团队”为唯一依据，积分结算模式通过团队配置/系统默认项进行统一路由。

---

### 实施TODO清单（分阶段）

为确保一次性重构顺利上线，按阶段拆分可执行任务。每条任务均需遵循统一返回与异常规范（仅返回 `ApiResult<T>`；业务异常抛 `ServiceException`；错误码来自 `ErrorCode`）。

#### Phase 0｜准备与变更冻结（1-2天）
- [ ] 评审最终方案与影响面，确认“团队为唯一边界”的一致性目标
- [ ] 建立灰度/开关位：`credit.settlement.mode.default`（默认 `USER_ONLY`）
- [ ] 预演 DDL 与迁移脚本，在测试库验证幂等与回滚
- [ ] 备份与回滚预案（库级备份、DDL回滚脚本、功能开关）

验收
- [ ] 评审通过；配置生效；DDL与回滚脚本通过演练

#### Phase 1｜数据库与迁移（1天）
- [ ] 执行新表 DDL：`teams`、`team_members`、`team_configs`
- [ ] 可选执行：`team_credits`、`team_credit_transactions`
- [ ] 创建必要索引（参见上文“索引与性能”）
- [ ] 初始化系统配置键：`credit.settlement.mode.default=USER_ONLY`
- [ ] 管理员默认团队初始化与历史子账号回填为团队成员（程序化/脚本化，保证幂等）

验收
- [ ] 表结构/索引存在且与文档一致；数据迁移条数符合预期；Explain 显示索引命中

#### Phase 2｜团队域基建（2天）
- [ ] 新增实体与 Mapper：`entity.team.Team`、`TeamMember`、`TeamConfig` 及对应 `mapper`
- [ ] 新增 `service.security.TeamAccessService` 接口与实现
- [ ] 单元测试：`TeamAccessService`（管理员/超级管理员/普通用户越权用例）

验收
- [ ] 覆盖核心判定分支；越权用例均通过；不引入 Controller 层返回实体/字符串的反模式

#### Phase 3｜TeamService 与 TeamController（2-3天）
- [ ] `service.team.TeamService`：团队 CRUD、成员管理、配置管理、审计
- [ ] `controller.team.TeamController`：
  - [ ] `GET /api/v1/teams` 列表/分页
  - [ ] `POST /api/v1/teams` 创建
  - [ ] `PUT /api/v1/teams/{id}` 更新
  - [ ] `DELETE /api/v1/teams/{id}` 删除
  - [ ] `GET /api/v1/teams/{id}/members` 成员列表
  - [ ] `POST /api/v1/teams/{id}/members` 添加成员
  - [ ] `PUT /api/v1/teams/{id}/members/{userId}` 变更角色/状态
  - [ ] `DELETE /api/v1/teams/{id}/members/{userId}` 移除成员
- [ ] 审计日志：关键操作入库

验收
- [ ] 所有接口使用 `ApiResult<T>` 返回；`ServiceException` 抛错；Swagger 文档可用

#### Phase 4｜统一越权改造（2天）
- [ ] `PermissionManagementServiceImpl`：将 `parentUserId` 判定改为 `TeamAccessService.canManageUser`
- [ ] `PermissionServiceImpl`：移除 `parentUserId` 依赖，改为团队边界
- [ ] `CreditTransactionServiceImpl`：`isSubUser` → 团队边界校验
- [ ] `UserLogServiceImpl`：子账号过滤 → `TeamAccessService.listManagedUserIds`

验收
- [ ] 指定用户对指定目标的越权用例全部覆盖并通过；未修改 Controller 捕获异常行为

#### Phase 5｜积分结算路由（3-4天）
- [ ] `CreditService` 引入结算路由：USER_ONLY/TEAM_ONLY/HYBRID
- [ ] `CreditServiceImpl`：
  - [ ] 可见范围替换为 `listManagedUserIds`
  - [ ] 在 TEAM_ONLY/HYBRID 下对接 `team_credits` 与流水 DAO
- [ ] 结算策略配置：`team_configs.CREDIT_SETTLEMENT_MODE`、HYBRID 策略（优先团队/优先个人/比例）
- [ ] 集成测试：三种模式的扣费/入账/并发场景

验收
- [ ] 三模式全通过；余额一致性无回归；并发下版本号/乐观锁正常

#### Phase 6｜注册与 XOR（1-2天）
- [ ] `dto.auth.request.UserRegisterRequest` 新增 `teamCode` 字段与 `cleanAndNormalize()`/校验
- [ ] XOR 规则：`teamCode` 与 `referralCode` 二选一，冲突抛 `ServiceException(ErrorCode.TEAM_JOIN_CONFLICT)`
- [ ] `AuthServiceImpl`：当 `teamCode` 有效时，注册后尝试加入团队（默认 `TEAM_CODE_DEFAULT_ROLE`，可选 `TEAM_CODE_REQUIRE_APPROVAL`）；加入失败不影响注册，需返回明确错误码（如 `TEAM_CODE_INVALID`、`USER_ALREADY_IN_TEAM`）
- [ ] 推荐码链路保持归因奖励，不影响团队关系
- [ ] 新增 `ErrorCode`：`TEAM_CODE_INVALID/TEAM_ALREADY_MEMBER/TEAM_JOIN_CONFLICT`

验收
- [ ] XOR 用例通过；团队加入/推荐奖励链路均通过；错误码与文案一致

#### Phase 7｜WebSocket 与前端契约（1天）
- [ ] 新增 `TOPIC_TEAM_CHANGED`，在团队/成员/配置变更后事务提交时推送
- [ ] 文档化前端订阅规范与事件载荷

验收
- [ ] 事件按团队维度可订阅；重复/漏发率为 0；不泄露敏感数据

#### Phase 8｜子账号 API 废弃与替换（1天）
- [ ] `UserController` 中子账号相关接口标注 `@Deprecated`，文档提示改用团队接口
- [ ] 前端改造：菜单迁移为“团队管理/成员管理”，移除“子账号”概念

验收
- [ ] 旧路由全部被替换；无遗留 UI 入口；接口调用链收敛

#### Phase 9｜文档、监控与告警（1天）
- [ ] 更新后端/前端 API 文档、使用手册与错误码清单
- [ ] 监控指标与告警：团队规模、越权拦截、结算失败率、并发冲突率

验收
- [ ] 文档齐全；仪表盘上线；阈值告警触发测试通过

#### Phase 10｜发布与回滚（0.5天）
- [ ] 预发验证：全链路回归（团队/积分/权限）
- [ ] 生产发布：开启团队边界，维持默认 `USER_ONLY` 观察
- [ ] 若观察稳定，再按团队逐步切换 `TEAM_ONLY` 或 `HYBRID`
- [ ] 回滚：一键切回 `USER_ONLY`，业务不中断

验收
- [ ] 观察期指标稳定；切换/回滚均无数据不一致

#### Phase 11｜清理与收尾（0.5天）
- [ ] 清理代码中残存的 `parentUserId` 判定
- [ ] 评估并计划移除 `User.parentUserId` 字段（下一个版本）
- [ ] 归档迁移脚本与运维手册
