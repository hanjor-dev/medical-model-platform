# 医学影像模型管理平台 - 用户和权限系统功能说明书

**文档版本**: v1.0  
**创建时间**: 2025-01-15  
**最后更新**: 2025-01-15  
**文档状态**: 已实现功能说明  

---

## 📋 目录

1. [系统概述](#1-系统概述)
2. [用户认证模块](#2-用户认证模块)
3. [用户管理模块](#3-用户管理模块)
4. [权限管理模块](#4-权限管理模块)
5. [动态权限配置](#5-动态权限配置)
6. [安全机制](#6-安全机制)
7. [API接口说明](#7-api接口说明)
8. [使用指南](#8-使用指南)

---

## 1. 系统概述

### 1.1 功能定位

医学影像模型管理平台的用户和权限系统是整个平台的核心安全基础设施，提供完整的用户生命周期管理、身份认证、权限控制和动态权限配置功能。系统采用现代化的架构设计，确保高安全性、高可用性和良好的扩展性。

### 1.2 核心特性

- **完整的用户管理体系**: 支持用户注册、登录、信息管理、密码修改等全生命周期操作
- **三级角色权限模型**: USER（普通用户）、ADMIN（管理员）、SUPER_ADMIN（超级管理员）
- **动态权限配置**: 支持运行时动态配置角色权限，无需重启应用即可生效
- **团队与成员管理**: 引入团队域 OWNER/ADMIN/MEMBER 角色模型，团队内协作与管理
- **推荐码机制**: 完整的用户推荐体系，支持推荐关系追踪
- **安全认证**: 基于Sa-Token的JWT认证机制，支持会话管理和权限验证
- **数据权限控制**: 结合团队边界（TeamAccessService）实现细粒度数据访问控制
- **密码安全**: 强密码策略和BCrypt加密存储

### 1.3 技术架构

- **认证框架**: Sa-Token v1.34.0，提供JWT Token管理和权限验证
- **数据存储**: MySQL 8.0+ 持久化存储，Redis缓存会话信息
- **密码加密**: Hutool BCrypt算法，确保密码安全
- **参数验证**: JSR-303 Bean Validation注解验证
- **异常处理**: 统一的异常处理机制和错误码管理
- **API文档**: Swagger 3.0自动生成接口文档

---

## 2. 用户认证模块

### 2.1 用户注册功能

#### 功能描述
提供新用户注册功能，支持推荐码机制，自动生成用户唯一标识和推荐码。

#### 核心特性
- **用户信息验证**: 用户名、邮箱、手机号唯一性检查
- **密码强度验证**: 8-20位长度，包含字母和数字的强密码要求
- **推荐码生成**: 自动生成8位唯一推荐码，支持用户推荐关系建立
- **角色初始化**: 新用户默认分配USER角色
- **积分系统预留**: 为未来积分系统集成预留接口

#### 业务流程
1. 用户提交注册信息（用户名、密码、邮箱、手机号、推荐码）
2. 系统验证用户名和邮箱的唯一性
3. 验证密码强度和格式规范
4. 处理推荐码关系（如果提供）
5. 生成唯一推荐码
6. 创建用户账户并初始化基础信息
7. 返回注册成功信息

#### 数据安全
- 密码使用BCrypt算法加密存储
- 用户名和邮箱唯一性约束
- 推荐码关系永久记录
- 创建时间和更新时间自动记录

### 2.2 用户登录功能

#### 功能描述
支持用户名或邮箱登录，集成强大的安全机制和登录日志记录。

#### 核心特性
- **多种登录方式**: 支持用户名或邮箱登录
- **安全验证**: 密码错误次数限制，账户锁定机制
- **Token管理**: Sa-Token JWT令牌生成和管理
- **登录日志**: 详细记录登录IP、位置、设备信息
- **会话管理**: 支持多设备登录和会话控制

#### 登录流程
1. 用户提交登录凭证（用户名/邮箱 + 密码）
2. 系统验证用户是否存在且账户状态正常
3. 验证密码正确性
4. 检查登录失败次数，防止暴力破解
5. 生成Sa-Token JWT令牌
6. 记录登录日志（IP、位置、设备信息）
7. 返回用户信息和访问令牌

#### 安全机制
- 密码错误次数限制（默认5次）
- 账户临时锁定机制
- IP地址和设备信息记录
- 登录状态实时验证
- Token过期自动处理

### 2.3 登录状态管理

#### 功能描述
基于Sa-Token的完整会话管理体系，支持登录状态检查、Token刷新和安全退出。

#### 核心功能
- **登录状态检查**: 实时验证用户登录状态
- **Token刷新**: 延长会话有效期
- **安全退出**: 清除服务端会话信息
- **多设备管理**: 支持同一用户多设备登录控制

#### 会话特性
- JWT Token自动续期
- Redis存储会话信息
- 跨服务会话共享
- 会话超时自动处理

---

## 3. 用户管理模块

### 3.1 个人信息管理

#### 功能描述
用户可以查看和修改自己的个人信息，包括基础信息和安全设置。

#### 支持的操作
- **信息查看**: 获取当前用户的详细信息
- **信息更新**: 修改邮箱、手机号、昵称、头像等
- **数据验证**: 邮箱格式、手机号格式验证
- **唯一性检查**: 邮箱修改时的唯一性验证

#### 可修改字段
- 邮箱地址（需要格式验证和唯一性检查）
- 手机号码（中国大陆11位手机号格式）
- 用户昵称（最大50个字符）
- 头像URL（最大500个字符）

#### 安全控制
- 只能修改自己的信息
- 敏感信息（如密码）不在响应中返回
- 修改操作记录审计日志

### 3.2 密码管理

#### 功能描述
提供安全的密码修改功能，包含严格的验证机制。

#### 密码修改流程
1. 用户提供当前密码和新密码
2. 验证当前密码正确性
3. 验证新密码强度要求
4. 更新密码并重新加密
5. 记录密码修改日志

#### 密码安全策略
- 8-20位长度要求
- 必须包含字母和数字
- 不能使用常见弱密码
- 不能有连续重复字符
- BCrypt加密存储

### 3.3 团队成员说明（取代“子账号”概念）

#### 背景
原“子账号”概念已废除，统一改为“团队成员”模型。团队成员由团队拥有者（OWNER）或管理员（ADMIN）在团队域内进行管理。

#### 说明
- 账号关系不再采用父子层级，统一通过团队成员关系管理协作边界。
- 成员角色为 OWNER/ADMIN/MEMBER，平台角色与团队角色解耦。
- 成员管理（新增/更新/移除、拥有者转移、团队配置、解散等）请参考《5-团队系统功能说明书》。

---

## 4. 权限管理模块

### 4.1 权限模型设计

#### 三级角色体系
- **USER（普通用户）**: 基础业务功能访问权限
- **ADMIN（管理员）**: 用户管理和部分系统管理权限
- **SUPER_ADMIN（超级管理员）**: 所有系统功能和权限配置权限

#### 团队域角色体系（团队模块）
- **OWNER（拥有者）**: 团队域最高权限，可转移拥有者、解散团队、管理成员与配置。
- **ADMIN（管理员）**: 团队成员管理、加入申请审批、配置更新等。
- **MEMBER（成员）**: 普通团队成员，具备团队内基础访问能力。

#### 权限类型分类
- **MENU权限**: 控制前端菜单显示和路由访问
- **BUTTON权限**: 控制页面内按钮和操作的显示
- **API权限**: 控制后端接口的访问权限

#### 权限树形结构
支持多级权限层次，每个权限可以有父权限和子权限，形成完整的权限树状结构，便于管理和授权。

### 4.2 权限验证机制

#### 接口级权限控制
- 基于Sa-Token注解的声明式权限控制
- 支持角色验证（@SaCheckRole）
- 支持权限验证（@SaCheckPermission）
- 自动拦截未授权访问

#### 数据级权限控制
- USER：默认只能访问自己的数据。
- 团队 OWNER/ADMIN：可在所属团队域内管理团队资源与成员数据（由 TeamAccessService 统一判定）。
- SUPER_ADMIN：可访问/管理所有团队与用户数据。

#### 权限验证流程
1. 用户发起请求
2. Sa-Token拦截器验证登录状态
3. 检查用户角色和权限
4. 验证数据访问权限
5. 允许或拒绝访问

### 4.3 权限查询服务

#### 用户权限查询
提供当前用户的完整权限信息，包括角色和详细权限列表。

#### 菜单权限构建
根据用户权限动态构建前端菜单树，支持多级菜单结构。

#### 权限缓存机制
- 权限信息实时从数据库查询
- 支持权限缓存刷新
- 权限修改立即生效

---

## 5. 动态权限配置

### 5.1 权限管理功能

#### 功能概述
超级管理员可以在运行时动态管理系统权限，包括权限的增删改查和角色权限配置。

#### 核心功能
- **权限CRUD**: 创建、修改、删除、查询权限
- **权限树管理**: 支持层次化权限结构管理
- **权限状态控制**: 启用/禁用权限功能
- **批量操作**: 支持批量删除权限

#### 权限创建
- 权限编码唯一性验证
- 权限类型选择（MENU/BUTTON/API）
- 父权限关系设置
- 菜单路径和组件配置
- 排序和状态设置

#### 权限修改
- 权限信息更新
- 父子关系调整
- 状态变更
- 排序调整

### 5.2 角色权限配置

#### 功能描述
动态配置不同角色的权限分配，支持细粒度的权限控制。

#### 配置功能
- **角色权限查看**: 查看指定角色的当前权限
- **权限分配**: 为角色分配新的权限
- **权限回收**: 取消角色的特定权限
- **批量配置**: 一次性配置角色的所有权限

#### 配置流程
1. 选择目标角色
2. 查看当前权限分配
3. 勾选或取消权限项
4. 提交权限配置
5. 系统立即生效

#### 实时生效
- 权限配置立即更新数据库
- 用户下次请求自动应用新权限
- 无需重启应用或清除缓存
- 支持权限缓存刷新

### 5.3 权限查询和检索

#### 分页查询
- 支持按权限类型筛选
- 支持关键词搜索
- 分页显示权限列表
- 排序和状态筛选

#### 权限树展示
- 完整的权限树形结构
- 父子关系清晰显示
- 角色权限状态标记
- 层级权限管理

---

## 6. 安全机制

### 6.1 身份认证安全

#### Token安全
- JWT Token签名验证
- Token过期自动处理
- 刷新Token机制
- 会话状态实时验证

#### 密码安全
- BCrypt强加密算法
- 密码强度策略
- 弱密码检测
- 密码修改审计

#### 登录安全
- 登录失败次数限制
- 账户锁定机制
- IP地址记录
- 设备信息追踪

### 6.2 权限控制安全

#### 接口安全
- 统一权限拦截器
- 声明式权限控制
- 异常权限处理
- 权限验证日志

#### 数据安全
- 多级数据权限控制
- 用户数据隔离
- 敏感信息过滤
- 数据访问审计

### 6.3 异常处理安全

#### 统一异常处理
- 全局异常拦截
- 安全错误信息
- 异常日志记录
- 用户友好提示

#### 错误码管理
- 分模块错误码
- 统一错误格式
- 多语言支持预留
- 错误追踪机制

---

## 7. API接口说明

### 7.1 用户认证接口

#### 用户注册
- **接口**: `POST /api/auth/register`
- **功能**: 新用户注册，支持推荐码
- **参数**: 用户名、密码、邮箱、手机号、推荐码
- **返回**: 用户ID、用户名、推荐码

#### 用户登录
- **接口**: `POST /api/auth/login`
- **功能**: 用户登录认证
- **参数**: 用户名/邮箱、密码
- **返回**: Token、用户信息、权限列表

#### 用户退出
- **接口**: `POST /api/auth/logout`
- **功能**: 安全退出登录
- **参数**: 无需参数
- **返回**: 操作结果

#### Token刷新
- **接口**: `POST /api/auth/refresh`
- **功能**: 刷新Token有效期
- **参数**: 无需参数
- **返回**: 新的Token

### 7.2 用户管理接口

#### 获取用户信息
- **接口**: `GET /api/user/profile`
- **功能**: 获取当前用户详细信息
- **权限**: 需要登录
- **返回**: 用户完整信息

#### 修改用户信息
- **接口**: `PUT /api/user/profile`
- **功能**: 修改个人信息
- **参数**: 邮箱、手机号、昵称、头像
- **权限**: 需要登录

#### 修改密码
- **接口**: `PUT /api/user/password`
- **功能**: 修改登录密码
- **参数**: 旧密码、新密码
- **权限**: 需要登录

#### 获取子账号列表
（已废弃）“子账号”接口已移除；团队与成员相关接口请参考《5-团队系统功能说明书》中的团队管理、成员管理、邀请与加入申请等接口。

### 7.3 权限查询接口

#### 获取用户权限
- **接口**: `GET /api/permissions/user`
- **功能**: 获取当前用户权限
- **权限**: 需要登录
- **返回**: 角色和权限列表

#### 获取菜单权限
- **接口**: `GET /api/permissions/menus`
- **功能**: 获取用户可访问菜单
- **权限**: 需要登录
- **返回**: 菜单树结构

### 7.4 权限管理接口（超级管理员）

#### 获取权限树
- **接口**: `GET /api/permissions/tree`
- **功能**: 获取完整权限树
- **权限**: SUPER_ADMIN角色

#### 角色权限树
- **接口**: `GET /api/permissions/role/{role}/tree`
- **功能**: 获取角色权限树
- **权限**: SUPER_ADMIN角色

#### 分页查询权限
- **接口**: `GET /api/permissions`
- **功能**: 分页查询权限列表
- **权限**: SUPER_ADMIN角色
- **参数**: 页码、大小、类型、关键词

#### 创建权限
- **接口**: `POST /api/permissions`
- **功能**: 创建新权限
- **权限**: SUPER_ADMIN角色
- **参数**: 权限详细信息

#### 更新权限
- **接口**: `PUT /api/permissions/{id}`
- **功能**: 修改权限信息
- **权限**: SUPER_ADMIN角色

#### 删除权限
- **接口**: `DELETE /api/permissions/{id}`
- **功能**: 删除指定权限
- **权限**: SUPER_ADMIN角色

#### 配置角色权限
- **接口**: `PUT /api/permissions/role`
- **功能**: 动态配置角色权限
- **权限**: SUPER_ADMIN角色
- **参数**: 角色、权限ID列表

### 7.5 团队相关接口（交叉引用）

为避免与本章“用户/权限”接口混淆，团队域接口的详细参数、请求/响应示例请参见《[5-团队系统功能说明书](./5-团队系统功能说明书.md)》。以下为快速索引：

- 团队管理（前缀：`/teams`）
  - `GET /teams`：分页查询团队列表（普通用户仅返回所属团队）
  - `POST /teams`：创建团队并设当前用户为 OWNER
  - `GET /teams/{id}`：获取团队详情（成员可见）
  - `PUT /teams/{id}`：更新团队信息
  - `DELETE /teams/{id}`：删除团队（软删）
  - `GET /teams/preview-by-code`：通过团队码预览团队信息
  - `GET /teams/{id}/members`：分页查询成员
  - `POST /teams/{id}/members`：添加成员（OWNER/ADMIN）
  - `PUT /teams/{id}/members/{userId}`：更新成员角色/状态
  - `DELETE /teams/{id}/members/{userId}`：移除成员
  - `POST /teams/{id}/transfer-owner`：转移拥有者（仅 OWNER）
  - `POST /teams/{id}/exit`：退出团队（OWNER 不可直接退出）
  - `POST /teams/{id}/dissolve`：解散团队（仅 OWNER）
  - `PUT /teams/{id}/status`：设置团队状态（仅 SUPER_ADMIN）

- 团队邀请（前缀：`/team/invitation`）
  - `POST /team/invitation`：创建邀请（支持用户ID/邮箱/手机号、多角色）
  - `GET /team/invitation/base-url`：获取邀请基础链接
  - `GET /team/invitation/{teamId}`：查询团队邀请列表（分页，可筛选）
  - `DELETE /team/invitation/{id}`：撤回邀请
  - `POST /team/invitation/accept`：接受邀请（通过令牌）

- 团队配置（前缀：`/team/config`）
  - `GET /team/config/{teamId}`：获取团队配置（键值对）
  - `PUT /team/config`：更新团队配置（覆盖写入）

---

## 8. 使用指南

### 8.1 管理员使用指南

#### 系统初始化
1. 使用默认超级管理员账户登录
2. 配置基础权限体系
3. 创建管理员账户
4. 分配相应权限

#### 权限管理流程
1. 登录系统并获取SUPER_ADMIN权限
2. 访问权限管理界面
3. 查看当前权限树结构
4. 根据业务需要创建新权限
5. 为不同角色分配权限
6. 测试权限生效情况

#### 团队与成员管理操作
1. 创建团队或进入所属团队的“团队管理”。
2. 通过团队模块管理成员（添加/更新/移除）、审批加入申请。
3. 根据需要调整团队配置或转移拥有者。
4. 监控团队相关操作与消息通知。

### 8.2 普通用户使用指南

#### 注册和登录
1. 访问注册页面
2. 填写必要的用户信息
3. 如有推荐码可以填写
4. 完成注册并登录系统
5. 查看可访问的功能模块

#### 个人信息管理
1. 登录后访问个人中心
2. 查看和修改基本信息
3. 定期更新密码
4. 管理账户安全设置

#### 团队协作指南
1. 通过团队邀请或提交加入申请加入团队。
2. 在团队内参与协作，按团队角色（MEMBER/ADMIN/OWNER）执行相应操作。
3. 需要退出团队时可在团队模块执行退出（OWNER 需先转移拥有者或解散）。

### 8.3 开发者集成指南

#### 前端集成
1. 调用登录接口获取Token
2. 在请求头中携带Token
3. 获取用户权限信息
4. 根据权限动态渲染界面
5. 处理权限异常情况

#### 权限验证集成
1. 在需要权限控制的接口上添加注解
2. 配置权限拦截器
3. 处理权限验证异常
4. 实现数据权限控制
5. 添加权限审计日志

#### 扩展开发
1. 了解权限模型设计
2. 扩展自定义权限类型
3. 实现业务相关权限逻辑
4. 集成第三方认证系统
5. 优化权限查询性能

---

## 附录

### A. 系统配置说明
- Sa-Token配置参数
- 密码策略配置
- 会话超时设置
- 权限缓存配置

### B. 错误码参考
- 1700-1799: 用户认证相关错误
- 1800-1899: 权限管理相关错误（预留）
- 常见错误处理方案

### C. 性能优化建议
- 权限查询优化
- 缓存策略建议
- 数据库索引优化
- 接口响应优化

### D. 安全最佳实践
- 密码安全策略
- Token管理规范
- 权限设计原则
- 安全审计建议

---

**文档结束**

> 本文档详细描述了医学影像模型管理平台用户和权限系统的已实现功能。系统采用现代化的技术架构，提供完整的用户管理、权限控制和动态配置功能，确保平台的安全性和可扩展性。 